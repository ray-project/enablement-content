
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Batch Inference with Ray Data &#8212; Course Notebooks Test</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom_hide.css?v=af9667c8" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'courses/01_examples/01_Ray_Data_batch_inference';</script>
    <script src="../../_static/custom_toggle.js?v=1235ef5b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Course Notebooks Test</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Ray Enablement Content
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Developer Intro to Ray</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00_Intro_Ray_Core_Basics_01.html">Introduction to Ray Core: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00_Intro_Ray_Core_Basics_02.html">0. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00_Intro_Ray_Core_Basics_03.html">1. Creating Remote Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00_Intro_Ray_Core_Basics_04.html">2. Executing Remote Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00_Intro_Ray_Core_Basics_05.html">4. Putting It All Together</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_01.html">Introduction to Ray Core (Advancement): Object store, Tasks, Actors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_02.html">1. Object store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_03.html">2. Chaining Tasks and Passing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_04.html">3. Task retries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_05.html">4. Task Runtime Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_06.html">5. Resource allocation and management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_07.html">6. Nested Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_08.html">7. Pattern: Pipeline data processing and waiting for results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/00a_Intro_Ray_Core_Advancement_09.html">8. Ray Actors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/01_Intro_Ray_AI_Libs_Overview_01.html">Introduction to the Ray AI Libraries: An example of using Ray data, Ray Train, Ray Tune, Ray Serve to implement a XGBoost regression model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/01_Intro_Ray_AI_Libs_Overview_02.html">1. Overview of the Ray AI Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/01_Intro_Ray_AI_Libs_Overview_03.html">2. Quick end-to-end example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02a_Intro_Ray_Train_with_PyTorch_01.html">Introduction to Ray Train + PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02a_Intro_Ray_Train_with_PyTorch_02.html">1. When to use Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02a_Intro_Ray_Train_with_PyTorch_03.html">2. Single GPU Training with PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02a_Intro_Ray_Train_with_PyTorch_04.html">3. Distributed Data Parallel Training with Ray Train and PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02b_Intro_Ray_Train_with_PyTorch_Lightning_01.html">Introduction to Ray Train: Ray Train + PyTorch Lightning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02b_Intro_Ray_Train_with_PyTorch_Lightning_02.html">1. When to use Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02b_Intro_Ray_Train_with_PyTorch_Lightning_03.html">2. Single GPU Training with PyTorch Lightning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02b_Intro_Ray_Train_with_PyTorch_Lightning_04.html">3. Distributed Training with Ray Train and PyTorch Lightning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/02b_Intro_Ray_Train_with_PyTorch_Lightning_05.html">4. Ray Train in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/03_Intro_Ray_Tune_01.html">Introduction to Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/03_Intro_Ray_Tune_02.html">1. Loading the data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/03_Intro_Ray_Tune_03.html">2. Starting out with vanilla PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/03_Intro_Ray_Tune_04.html">3. Hyperparameter tuning with Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/03_Intro_Ray_Tune_05.html">4. Ray Tune in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04a_Intro_Ray_Data_Industry_Landscape_01.html">Introduction to Ray Data: Industry Landscape</a></li>

<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04a_Intro_Ray_Data_Industry_Landscape_02.html">The Compute Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04a_Intro_Ray_Data_Industry_Landscape_03.html">The Orchestration Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04a_Intro_Ray_Data_Industry_Landscape_04.html">Distributed Computing Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04a_Intro_Ray_Data_Industry_Landscape_05.html">Data Processing with Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04a_Intro_Ray_Data_Industry_Landscape_06.html">Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04b_Intro_Ray_Data_Structured_01.html">Introduction to Ray Data: Ray Data + Structured Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04b_Intro_Ray_Data_Structured_02.html">0. What is Ray Data?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04b_Intro_Ray_Data_Structured_03.html">2. Loading Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04b_Intro_Ray_Data_Structured_04.html">3. Transforming Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04b_Intro_Ray_Data_Structured_05.html">4. Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04b_Intro_Ray_Data_Structured_06.html">5. Data Operations: Shuffling, Grouping and Aggregation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04b_Intro_Ray_Data_Structured_07.html">6. When to use Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_01.html">Intro to Ray Data:  Ray Data + Unstructured Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_02.html">1. When to Consider Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_03.html">2. How to work with Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_04.html">3. Loading data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_05.html">3. Lazy execution mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_06.html">4. Transforming data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_07.html">5. Stateful transformations with Ray Actors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_08.html">6. Materializing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_09.html">7. Data Operations: grouping, aggregation, and shuffling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_10.html">8. Persisting data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/04c_Intro_Ray_Data_Unstructured_11.html">9. Ray Data in production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/05_Intro_Ray_Serve_PyTorch_01.html">Introduction to Ray Serve with PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/05_Intro_Ray_Serve_PyTorch_02.html">1. When to Consider Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/05_Intro_Ray_Serve_PyTorch_03.html">2. Overview of Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/05_Intro_Ray_Serve_PyTorch_04.html">3. Implement an image classification service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/05_Intro_Ray_Serve_PyTorch_05.html">4. Development workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_Developer_Intro_to_Ray/output/README_01.html">Introduction to Ray: Developer</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">01 Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="output/01_Ray_Data_batch_inference_01.html">Batch Inference with Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/01_Ray_Data_batch_inference_02.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/01_Ray_Data_batch_inference_03.html">Load a dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/01_Ray_Data_batch_inference_04.html">Batch Inference Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/01_Ray_Data_batch_inference_05.html">Create a batch data and call the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/01_Ray_Data_batch_inference_06.html">Run inference on the entire dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02_Ray_Data_data_processing_01.html">Data Processing with Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02_Ray_Data_data_processing_02.html">Library Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02_Ray_Data_data_processing_03.html">Convert to Ray Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02_Ray_Data_data_processing_04.html">Filter Ray Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02_Ray_Data_data_processing_05.html">Join Two Ray Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02_Ray_Data_data_processing_06.html">Preprocessing with a Tokenizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Ray_Serve_online_serving_01.html">Online Model Serving with Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Ray_Serve_online_serving_02.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Ray_Serve_online_serving_03.html">FastAPI webservice and deploy a model</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Ray_Serve_online_serving_04.html">Simulate Client: Send test requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04_Ray_Train_distributed_training_01.html">Distributed training with Ray Train, PyTorch and Hugging Face</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04_Ray_Train_distributed_training_02.html">1. Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04_Ray_Train_distributed_training_03.html">3. Metrics Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04_Ray_Train_distributed_training_04.html">4. Training function per worker</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04_Ray_Train_distributed_training_05.html">5. Main Training Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04_Ray_Train_distributed_training_06.html">6. Start Training</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Anyscale 101</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_jobs_01.html">Content Used</a></li>

<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_jobs_02.html">Part 1. Creating and Submitting your first job</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_jobs_03.html">Part 2. Automation and Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_services_01.html">Sources</a></li>

<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_services_02.html">Part 1: Starting your first Anyscale Service</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ray 101</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/1_AI_Libs_Intro_01.html">Introduction to the Ray AI Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/1_AI_Libs_Intro_02.html">1. Overview of the Ray AI Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/1_AI_Libs_Intro_03.html">2. End-to-end example: predicting taxi tips in New York</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/1_AI_Libs_Intro_04.html">3. Running an experiment with Ray AI libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_01.html">Introduction to Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_02.html">1. PyTorch introductory example (single GPU)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_03.html">2. Distributed Data Parallel Training with Ray Train and PyTorch (multiple GPUs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_04.html">3. Overview of the training loop in Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_05.html">4. Migrating the model and dataset to Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_06.html">5. Reporting checkpoints and metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_07.html">6. Launching the distributed training job</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_08.html">7. Accessing the training results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_09.html">8. Ray Train in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_01.html">Intro to Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_02.html">1. Loading and visualizing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_03.html">2. Setting up a PyTorch model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_04.html">3. Introduction to Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_05.html">4. Diving deeper into Ray Tune concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_06.html">5. Hyperparameter tuning the PyTorch model using Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_01.html">Intro to Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_02.html">1. When to use Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_03.html">2. Loading Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_04.html">3. Transforming Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_05.html">4. Data Operations: Grouping, Aggregation, and Shuffling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_06.html">5. Persisting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_01.html">Intro to Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_02.html">1. Overview of Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_03.html">2. Implement an Classifier service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_04.html">3. Advanced features of Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_05.html">4. Ray Serve in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_06.html">Clean up</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/courses/01_examples/01_Ray_Data_batch_inference.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Batch Inference with Ray Data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outline">Outline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import Libraries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-a-dataset">Load a dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-inference-class">Batch Inference Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-batch-data-and-call-the-model">Create a batch data and call the model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deploying-at-scale">Deploying at scale</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-inference-on-the-entire-dataset">Run inference on the entire dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#out-of-memory-errors">Out of memory errors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shutdown-ray-cluster">Shutdown Ray cluster</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="batch-inference-with-ray-data">
<h1>Batch Inference with Ray Data<a class="headerlink" href="#batch-inference-with-ray-data" title="Link to this heading">#</a></h1>
<p>© 2025, Anyscale. All Rights Reserved</p>
<p>💻 <strong>Launch Locally</strong>: You can run this notebook locally.</p>
<p>🚀 <strong>Launch on Cloud</strong>: Think about running this notebook on a Ray Cluster (Click <a class="reference external" href="http://console.anyscale.com/register">here</a> to easily start a Ray cluster on Anyscale)</p>
<p>This example shows how to do batch inference with Ray Data.</p>
<p>Batch inference with Ray Data enables you to efficiently generate predictions from machine learning models on large datasets by processing multiple data points at once. Instead of running inference on one row at a time, which can be slow and resource-inefficient, batch inference leverages vectorized computation and parallelism to maximize throughput. This is especially useful when working with modern deep learning models, which are optimized for batch processing on CPUs, GPUs, or Apple Silicon devices.</p>
<p>The typical workflow begins by loading your dataset—such as a public dataset from Hugging Face—into a Ray Dataset. Ray Data can automatically partition the data for parallel processing, or you can repartition it explicitly to control the number of data blocks. Once the data is loaded, you define a callable class (such as a text embedding model) that loads the machine learning model in its constructor and implements a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method to process each batch. Ray Data’s <code class="docutils literal notranslate"><span class="pre">map_batches</span></code> API is then used to apply this callable to each batch of data, with options to control concurrency and resource allocation (e.g., number of GPUs).</p>
<p>This approach allows you to spin up multiple concurrent model instances, each processing different batches of data in parallel. The result is a significant speedup in inference time, especially for large datasets. After inference, you can materialize the results, inspect the output, and shut down the Ray cluster to free up resources. Batch inference with Ray Data is scalable, flexible, and integrates seamlessly with modern ML workflows, making it a powerful tool for production and research environments alike.</p>
<section id="outline">
<h2>Outline<a class="headerlink" href="#outline" title="Link to this heading">#</a></h2>
<div class="alert alert-block alert-info">
<b>In this notebook, we go through a typical ML batch inference workflow:</b>
<ul>
    <li>Architecture
    <li>Import Libraries
    <li>Load a public dataset from Hugging Face and move it into Ray Data object store.
    <li>Batch Inference Class
        - Create a Ray actor class to load a ML model. In this example, we use SentenceTransformer library from Hugging Face to load a sentence embedding model.
    <li>Create batches of data to do inference.
    <li>Deploying at Scale
    <li>Inference on the entire dataset
    <li>Out of memory errors
    <li>Summary
</ul>
</div></section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading">#</a></h2>
<p><img alt="Architecture Diagram" src="https://lz-public-demo.s3.us-east-1.amazonaws.com/anyscale101/01_examples/01_Ray_Data_batch_inf_arch.svg?sanitize=true" /></p>
<section id="import-libraries">
<h3>Import Libraries<a class="headerlink" href="#import-libraries" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span> <span class="c1"># huggingface sentence transformers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span> <span class="c1"># huggingface datasets</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="load-a-dataset">
<h2>Load a dataset<a class="headerlink" href="#load-a-dataset" title="Link to this heading">#</a></h2>
<p>Load a dataset from hugging face or local and convert into Ray Dataset. A Ray cluster automatically initialized on local or on Anyscale platform. You can also use <strong>ray.init()</strong> To explicitly create or connect to an existing Ray cluster.</p>
<p><a class="reference external" href="https://docs.ray.io/en/latest/ray-core/api/doc/ray.init.html#ray.init">https://docs.ray.io/en/latest/ray-core/api/doc/ray.init.html#ray.init</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load a Hugging Face dataset</span>
<span class="n">hf_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;cardiffnlp/tweet_eval&quot;</span><span class="p">,</span> <span class="s2">&quot;sentiment&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="c1"># Convert the Hugging Face dataset to a Ray Dataset</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">from_huggingface</span><span class="p">(</span><span class="n">hf_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># repartition to 2 blocks for parallel processing. Not necessary if already partitioned due to the size of the dataset.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset metadata</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Repartition
+- Dataset(num_rows=45615, schema={text: string, label: int64})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># show the first 10 rows</span>
<span class="c1"># Each row has &quot;text&quot; and &quot;label&quot;</span>
<span class="n">ds</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8eac2fbc0161458aac6f00b7e6229ee8", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9166eb441b174da1ade0145a0adfabb1", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "16140611d5db4cda96a863d4764f33e1", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "34cce002da6e4036b13231eee4ff410d", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;text&#39;: &#39;&quot;QT @user In the original draft of the 7th book, Remus Lupin survived the Battle of Hogwarts. #HappyBirthdayRemusLupin&quot;&#39;, &#39;label&#39;: 2}
{&#39;text&#39;: &#39;&quot;Ben Smith / Smith (concussion) remains out of the lineup Thursday, Curtis #NHL #SJ&quot;&#39;, &#39;label&#39;: 1}
{&#39;text&#39;: &#39;Sorry bout the stream last night I crashed out but will be on tonight for sure. Then back to Minecraft in pc tomorrow night.&#39;, &#39;label&#39;: 1}
{&#39;text&#39;: &quot;Chase Headley&#39;s RBI double in the 8th inning off David Price snapped a Yankees streak of 33 consecutive scoreless innings against Blue Jays&quot;, &#39;label&#39;: 1}
{&#39;text&#39;: &#39;@user Alciato: Bee will invest 150 million in January, another 200 in the Summer and plans to bring Messi by 2017&quot;&#39;, &#39;label&#39;: 2}
{&#39;text&#39;: &quot;@user LIT MY MUM &#39;Kerry the louboutins I wonder how many Willam owns!!! Look Kerry Warner Wednesday!&#39;&quot;, &#39;label&#39;: 2}
{&#39;text&#39;: &#39;&quot;\\&quot;&quot;&quot;&quot; SOUL TRAIN\\&quot;&quot;&quot;&quot; OCT 27 HALLOWEEN SPECIAL ft T.dot FINEST rocking the mic...CRAZY CACTUS NIGHT CLUB ..ADV ticket $10 wt out costume $15...&quot;&#39;, &#39;label&#39;: 2}
{&#39;text&#39;: &#39;So disappointed in wwe summerslam! I want to see john cena wins his 16th title&#39;, &#39;label&#39;: 0}
{&#39;text&#39;: &#39;&quot;This is the last Sunday w/o football .....,NFL is back baby&quot;&#39;, &#39;label&#39;: 2}
{&#39;text&#39;: &quot;@user @user CENA &amp; AJ sitting in a tree K-I-S-S-I-N-G 1st goes AJ&#39;s  job then John&#39;s cred then goes Vicki with the GM position.&quot;, &#39;label&#39;: 1}
</pre></div>
</div>
</div>
</div>
</section>
<section id="batch-inference-class">
<h2>Batch Inference Class<a class="headerlink" href="#batch-inference-class" title="Link to this heading">#</a></h2>
<p>Many machine learning models are optimized for processing a batch of inputs at once. When working with a large dataset, there could be many batches of data. Instead of loading machine learning models repeatedly to run each batch of data, you want to spin up a number of actor processes that are <strong>initialized once</strong> with your model <strong>and reused</strong> to process multiple batches.</p>
<p>To implement this, you can use the <code class="docutils literal notranslate"><span class="pre">map_batches</span></code> API with a “Callable” class method that implements:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code>: Initialize any expensive state.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__call__</span></code>: Perform the stateful transformation.</p></li>
</ul>
<p>In this example, a lightweight sentence transformer model, <strong>all-MiniLM-L6-v2</strong> is used to generate embeddings of text data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an Ray actor class to embed text using the SentenceTransformer model</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TextEmbedder</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># load a pretrained sentence transformer model</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;all-MiniLM-L6-v2&quot;</span>  <span class="c1"># A popular, lightweight sentence transformer model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="c1"># automatically detects cuda, mps, cpu</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="c1"># use the &quot;text&quot; column</span>
        <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;embedding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span> <span class="c1"># create embedding</span>
        <span class="k">return</span> <span class="n">batch</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-batch-data-and-call-the-model">
<h2>Create a batch data and call the model<a class="headerlink" href="#create-a-batch-data-and-call-the-model" title="Link to this heading">#</a></h2>
<p>Define a Ray Data map_batches function to embed text using the SentenceTransformer model. This function will be applied to each batch of data in the Ray Data dataset. It will take a batch of sentences, encode them into embeddings, and return the batch with the embeddings added.</p>
<p>Showcasing two options of to do batch inference based on if the ray cluster has have GPU nodes or if it has just CPU nodes. The second option also works on a local ray cluster on an Apple Silicon Mac with MPS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setting manually so that code works on ray clusters with both CPU or GPU workers, or on a local mac with MPS</span>
<span class="n">worker_device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span> <span class="c1"># or &quot;cuda&quot; if you have a nvidia gpu on worker nodes</span>
<span class="c1"># batch_size should be set based on VRAM </span>
<span class="k">if</span> <span class="n">worker_device</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span> <span class="c1"># if you have a nvidia gpu on worker nodes</span>
    <span class="c1"># adjust batch_size based on the VRAM available on the GPU</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">TextEmbedder</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span> <span class="c1"># 2 nodes with 1 GPU each</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">TextEmbedder</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span> <span class="c1"># either cpu or mps (on a mac)</span>
</pre></div>
</div>
</div>
</div>
<section id="deploying-at-scale">
<h3>Deploying at scale<a class="headerlink" href="#deploying-at-scale" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The batch size for encoding can be adjusted based on the available memory and performance requirements.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">device</span></code> parameter ensures that the model runs on the correct device (CPU, GPU, or MPS).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">concurrency</span></code> parameter controls how many batches are processed in parallel. If there are 2 nodes with 1 GPU each or 1 node with 2 GPUs, then set concurrency = 2 and num_gpus=1.</p></li>
<li><p>map_batches() is a lazy function and not executed until needed (example, using take or show).</p></li>
</ul>
<p>Run inference on a batch of 128 rows. This will return a batch of 128 rows with the embeddings added to the caller’s machine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run inference on a batch of 128 rows for testing.</span>
<span class="n">ds</span><span class="o">.</span><span class="n">take_batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6b7b173fb7dd49bf9afe2295437c1b86", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "d2b2f0ab1e284a219bd6e0c1503c46b5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "786e104a4043482ea8d3154eeb55f061", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "fc842736d27e41e9837238b546b56a3e", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "cafc1111d0124878ad187602bcec6ff4", "version_major": 2, "version_minor": 0}</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;text&#39;: array([&#39;&quot;QT @user In the original draft of the 7th book, Remus Lupin survived the Battle of Hogwarts. #HappyBirthdayRemusLupin&quot;&#39;,
        &#39;&quot;Ben Smith / Smith (concussion) remains out of the lineup Thursday, Curtis #NHL #SJ&quot;&#39;,
        &#39;Sorry bout the stream last night I crashed out but will be on tonight for sure. Then back to Minecraft in pc tomorrow night.&#39;,
        &quot;Chase Headley&#39;s RBI double in the 8th inning off David Price snapped a Yankees streak of 33 consecutive scoreless innings against Blue Jays&quot;,
        &#39;@user Alciato: Bee will invest 150 million in January, another 200 in the Summer and plans to bring Messi by 2017&quot;&#39;,
        &quot;@user LIT MY MUM &#39;Kerry the louboutins I wonder how many Willam owns!!! Look Kerry Warner Wednesday!&#39;&quot;,
        &#39;&quot;\\&quot;&quot;&quot;&quot; SOUL TRAIN\\&quot;&quot;&quot;&quot; OCT 27 HALLOWEEN SPECIAL ft T.dot FINEST rocking the mic...CRAZY CACTUS NIGHT CLUB ..ADV ticket $10 wt out costume $15...&quot;&#39;,
        &#39;So disappointed in wwe summerslam! I want to see john cena wins his 16th title&#39;,
        &#39;&quot;This is the last Sunday w/o football .....,NFL is back baby&quot;&#39;,
        &quot;@user @user CENA &amp; AJ sitting in a tree K-I-S-S-I-N-G 1st goes AJ&#39;s  job then John&#39;s cred then goes Vicki with the GM position.&quot;,
        &#39;@user Well said on HMW. Can you now address why Texans fans file out of the stadium midway through the 4th qtr of every game?&#39;,
        &quot;Just said hello to Dennis Kucinich as he walked casually through campus with his #hotwife. He&#39;s on 22nd st!&quot;,
        &#39;Super excited for homecoming Saturday with Monroe! :D my new nephew is here but I can\\u2019t see him :(&#39;,
        &#39;That sucks if you have to take the SATs tomorrow&#39;,
        &#39;@user  6 tickets for Sam smith concert  Sept 30 cheap! Flew our family of 6 here fir the concert! BEYOND UPSET!&#39;,
        &#39;&quot;Fiorentina have reportedly opened talks with Chelsea over taking the 20yr old Kurt Zuoma on loan in January.&quot;&#39;,
        &#39;Creighton Volleyball leads 8-5 early in 2nd set. Match becomes even bigger with both Wichita St. &amp; Missouri State down 0-1 at home tonight.&#39;,
        &quot;This time tomorrow...we&#39;ll have the Iron on. Iron Maiden pieces Drops tomorrow nights.&quot;,
        &quot;Amy Schumer sat down with The Hollywood Reporter and opened up about the sexist remarks and unnecessary criticism she&#39;s faced since&quot;,
        &quot;What is Jamie Foxx doing sitting next to Niall like you could&#39;ve sat in a better spot just saying lol&quot;,
        &#39;@user @user 1st uneasyness was when he got v defensive about the Charlie Hebdo stuff, even tho he had pals patiently explaining&quot;&#39;,
        &#39;Reminder: Samsung Unveils the Galaxy Note 5 and S6 Edge+ Tomorrow Morning! - - #tech #news...&#39;,
        &#39;&quot;Gonna do a movie marathon with my friend today and tomorrow. Twilight, New Moon, Eclipse, BD1, The Runaways, Adventureland, (c)&quot;&#39;,
        &#39;Oscars Well makes his debut over fences at Punchestown tomorrow. It looks as though he\\u2019ll have Plan A and Darwins Fox to overcome.&#39;,
        &#39;Q2 10:30. Philip Rivers pass to Eddie Royal to the San Diego 19 for 7 yards. 3rd &amp; 1.&#39;,
        &#39;@user Work colleague of mine on Thursday night: &quot;&quot;oh, look, they\&#39;re showing the Bee Gees on video.&quot;&quot; 23-yr old colleague: &quot;&quot;who?&quot;&quot;&quot;&#39;,
        &quot;Who&#39;s going to get them Gucci foams tomorrow&quot;,
        &#39;Yes glass of red\\u002c Rammstein and day off tomorrow (thank you @user just what I needed.&#39;,
        &#39;Vampettes we are back on the 21st place keep tweeting with the hashtag #MTVStars The Vamps #MTVStarsOf2015&#39;,
        &#39;Ryan Braun returned to the lineup on Wednesday after missing two games with lower back tightness.&#39;,
        &#39;&quot;#Ichiro has nothing. If you want to see hustle: Kenny Lofton, 17 October 1995, scores from second base on a past ball. #GoTribe #ALDS&quot;&#39;,
        &#39;Looking forward to going to Carrow Rd tonight. Last time we were there\\u002c Bale scored 2 and we were 3rd. Do not want extra time though&#39;,
        &#39;Gonna go to the north game tomorrow night. I better see some of you north kiddos&#39;,
        &#39;Right guys\\u002c last competition of the night... Like this status for a chance to win a copy of Judas Priest\\u2019s 30th...&#39;,
        &#39;We\\u2019re in the studio working on the new album and it sounds EPIC. We may as well pick up our Brit Award now\\u002c tbh.&#39;,
        &#39;&quot;last day of august, waiting for frank ocean to pull a beyonce.&#39;,
        &#39;#INFO --&gt; Grand opening sharetea bubble tea with @user 2 nov 2012 mall taman anggrek 11:00 - 14:00 * Jadwal ke-1 besok !&#39;,
        &#39;Sunday (tomorrow) is National Ice Cream Day and have we got a gift for you!   Join us for an ice cream sundae and...&#39;,
        &#39;Gucci pants himself store january lay open the span thine atomic irruptive concomitant so that cons comburent:...&#39;,
        &#39;still not over how Nicki snapped like a 12th grader on their last day of high school&#39;,
        &#39;I may or may not buy myself the illustrated version of Harry potter for my birthday&#39;,
        &#39;I wanna see STUDIO FOOTAGE SO BAD. We are about to hear some unreleased STUFF! Likeeeeeeeeee I can\\u2019t wait until Sunday.&#39;,
        &#39;@user how the hell does every one else get to keep their religious and 1st amnt rights, except Christians!!! This is just wrong!!!&quot;&#39;,
        &#39;A @user rule change should allow Carly Fiorina to earn a spot on the main stage for the 2nd Republican debate.&#39;,
        &#39;&quot;TFI Friday doesn\&#39;t look like it\&#39;s coming back, as Chris Evans focuses on new-look Top Gear&#39;,
        &#39;#np The Way You Make Me Feel - 2012 Remaster by Michael Jackson from the album Bad 25th Anniversary.&#39;,
        &#39;&quot;I\&#39;m going to see Paper Towns. Saturday, 22 August 2015 at 17:40 in Leigh #Cineworld&quot;&#39;,
        &#39;@user Yepo I came in Milan it was my 1st concert and it was so good you guys did an amazing job! You are flawless live like PERFECT!&#39;,
        &#39;#days #dool Tuesday Hope has to pick up Ciara. Rafe wants a real case not just publicity like Justin&#39;,
        &#39;Seth Rollins talks &amp;amp; talks every Monday on RAW for about 45 minutes&#39;,
        &#39;Thanks manager for putting me on the schedule for Sunday&quot;&#39;,
        &quot;I&#39;m sat at work just laughing at all these Hulk Hogan tweets. Hahha ffs&quot;,
        &quot;@user #MLBCentral David Wright crushing a dinger on his first swing since April 14th. I didn&#39;t think he would pull a Wilmer Flores!&quot;,
        &#39;I feel like the new Janet Jackson single is bringing back 90s R&amp;amp;B. via @user&#39;,
        &#39;Anyone want to see Sam smith with me on October 6th?&#39;,
        &#39;This Friday OUTHOUSE is playing at Still Partners in Sea Cliff ! Hop on the Expressway to Nirvana!&#39;,
        &#39;&quot;You can\&#39;t shit talk Kpop. Every group is so in sync and vocally on point. It may not be your thing, but it\&#39;s talent.&quot;&#39;,
        &#39;I hope Milan mom say that she can come over on the 28th&#39;,
        &#39;Don\\u2019t forget Mitch Daniels is going to be on Steven Colbert\\u2019s show Thursday.  Think this will come up as a topic?&#39;,
        &quot;Amazon prime is literally a lie....I ordered a book LAST MONDAY &amp;amp; it still isn&#39;t here. do better @user&quot;,
        &#39;Who the hell moshes at Matt and Kim?? Next time watch out for my face\\u002c mofos! My cheekbones better not be purple tomorrow. @user&#39;,
        &#39;&quot;What a difference not having Sterling on the pitch makes! Welbeck dragged wide 1st half, the Ox replaces Sterling, Welbeck down middle, goal&quot;&#39;,
        &#39;&quot;Dear lovely Christians, I wish to inform you, tomorrow we got one Mass @ 10am as we\&#39;ll be submitting our parish family day collection!&quot;&#39;,
        &#39;&quot;To Kpop fans, we song along to vocals, 2nd voices, raps, fanchants, do the instruments &amp;amp; even perform its own choreo&#39;,
        &#39;Cherie Blair is sat on our coach going to the games! #Olympics2012&#39;,
        &#39;continued : Emmanuel Adebayor has not travelled with the squad for our Europa League away tie in Greece tomorrow evening.&#39;,
        &quot;Mario Williams is catching hell! He will be Exposed on Sunday... Not like Buffalo don&#39;t see him 4 who he is Already!&quot;,
        &#39;&quot;Kris Bryant hurt, Joe Maddon ejected in today\&#39;s Cubs game, and it\&#39;s only the 6th inning.&#39;,
        &#39;@user Last Wednesday, when I saw you dressed as Robin, all I can think about is &quot;Who\&#39;s Batman? Where\&#39;s the Teen Titans?&quot;&#39;,
        &#39;@user Brock lesnar live from madison square garden sounds like it could just be a live feed of him sat on a chair for 3 hours&#39;,
        &#39;@user Frank ocean releasing his second album december 31st 2015 on new years eve. heres the interview...&#39;,
        &#39;@user @user at da end of da night no girl that roll with me is on da MTA! They are above that as long as I can afford that!&#39;,
        &#39;@user SCOTUS based their argument on the 14th. No matter how you stretch it race was not involved.&#39;,
        &quot;My mom&#39;s over here tryna tell me that we&#39;re taking the CAHSEE tomorrow ._. Nigga it&#39;s only the second month of school.. #SlowYourRoll&quot;,
        &#39;&quot;Rahul Gandhi held Indian citizenship from day one: Congress: New Delhi, Nov 18: Dismissing BJP leader Subraman...&#39;,
        &#39;&quot;I\&#39;m going to Paramore at Rock Im Park in Nuremburg, Germany - Jun 8&#39;,
        &#39;Happy Birthday Nick J  May you live long and Happy :)&#39;,
        &#39;ECHO: Sex offender is warned he may face jail over offences #Dorset&#39;,
        &#39;I hope Bernie Sanders is a sun and the other two are shooting stars or black holes.&#39;,
        &#39;&quot;Shows how much you can trust drivers answering these questions. Alonso was still saying on Monday that Ferrari split is &quot;&quot;&quot;&quot;just a rumor.&quot;&quot;&quot;&quot; #F1&quot;&#39;,
        &#39;Who else is going to the Chris brown tour this Thursday #ChrisBrown#onehellofanighttour&#39;,
        &#39;Your inspirational quotes on twitter/Feb never really got to me. But oh damn ur pics of them on IG have truly inspired me. #idiots&quot;&#39;,
        &#39;Another beauty of a day in Athens\\u002c Greece. I trust you\\u2019ll have an exceptional Friday wherever in the world you are. Much love.&#39;,
        &#39;&quot;Another great night in Split, off to Hvar on the 8:30 ferry tomorrow morning... dreading the packing but excited to get there!&quot;&#39;,
        &quot;@user and im seeing Ed live this Saturday at b&#39;ham NIA! It would be amazing to get the book signed. Thanks for putting it together&quot;,
        &#39;&quot;Church tonight, who will you bring????&quot;&#39;,
        &#39;Q_Q Today was the day that Naruto shippuden: UNS4 was suppose to come out. WHYYYYYYY DID THEY PUSH IT ALL THE WAY TO JAN???? HELLO&#39;,
        &#39;Pics of the March Fourth Marching Band at the Oregon Country Fair closing out the show Sunday night. Their...&#39;,
        &#39;The audio booth is ready to blow the roof off the Comcast Center tomorrow! Are you? #MDMadness&#39;,
        &#39;welllll who wants to see Ed Sheeran with me on the 17th????&#39;,
        &#39;GOALdotCOM: Premier League Team of the Week: Van Persie &amp; Aguero both star after City &amp; Arsenal wins&#39;,
        &quot;The Hitchhiker&#39;s Guide to the Galaxy Game - 30th Anniversary Edition Need to sign up with the BBC online.&quot;,
        &quot;I&#39;m seeing Ed Sheeran on Wednesday in Miami so if you wanna meet up or say hi hmu!&quot;,
        &#39;&quot;Chuck Close shares his best-kept secrets with @user on the eve of his new show, opening Thursday @user&#39;,
        &#39;Vermaelen the hero for Barca: Thomas Vermaelen was the unlikely hero as Barcelona laboured to a 1-0 home win over Malaga on Saturday ...&#39;,
        &#39;@user I\\u2019m sick with something ill be at school on Monday though&#39;,
        &#39;&quot;There\&#39;s something about Friday Night Lights, you just get chills thinking about it .&quot;&#39;,
        &#39;Googled the snake I stepped over on the trail Sunday. Baby timber rattler. So time to Google &quot;snake-proof hiking boots.&quot;&#39;,
        &#39;@user Also, his anger against Hindus are justified but couldn\&#39;t get why he was so anti Islam..may be he was just fed up of religions&quot;&#39;,
        &#39;Ricky Ponting and I now have something in common. Today he passed 23\\u002c000 1st class runs. Last night at training\\u002c i was hit for 23\\u002c000 runs.&#39;,
        &#39;Ted Nugent talks to us about #hunting and other stuff he\\u2019s got on his mind @user this Saturday at 7am on the Great Outdoors\\u002c #nuge&#39;,
        &#39;Check out Newsha Tavakolian at the Saatchi Gallery in London. Her photos of Iran may interest some of you!&#39;,
        &quot;Mansbridge destroyed Justin tonite the polls for the lib&#39;s should tank tomorrow! Wake up people he is NOT ready!!&quot;,
        &#39;For the ones tomorrow sunday in Milan (Italy): Aperitif and evening at Fiat Open Lounge:&#39;,
        &#39;&quot;J\&#39;regarde des infos sur Ragnarok (le film) &amp;amp;bon: &quot;&quot;Thor will make it out of the third movie[..]Loki, on the other hand may not be so Lucky.&quot;&quot;&quot;&#39;,
        &#39;@user Donald trump said the same thing about the tax rate.  Fact check said he was a liar &quot;pant of fire&quot;&#39;,
        &#39;&quot;If you\\u2019re calling this little thing right here a \\&quot;&quot;&quot;&quot;party\\&quot;&quot;&quot;&quot; then Friday night\\u2019s gonna be Project X\\u002c Y\\u002c &amp; Z.&quot;&#39;,
        &#39;&quot;Love this vid!! 1st time I\\u2019ve seen it!--- jules explains it all - David Archuleta sings \\&quot;&quot;&quot;&quot;Nandito Ako.\\&quot;&quot;&quot;&quot; via @user&#39;,
        &#39;@user @user Not just Christians, you are in the prayers of &quot;&quot;all of us&quot;&quot; humans.May you stay safe and be free soon!God bless.&quot;&#39;,
        &#39;Happy birthday @user ! National Bieber Day . Now he\\u2019s 18th years\\u002c but he\\u2019s #stillkidrauhl #IndonesiaSaysHBDforJustinBieber&#39;,
        &#39;&quot;If you put one over the plate he\&#39;s gonna fuck you up  Called it, Kris Bryant with his 21st&quot;&#39;,
        &#39;Good luck to Girls Tennis as the take on South Torrance today on 1st round CIF! #GoLions2012&#39;,
        &#39;&quot;\\&quot;&quot;Hey\\u002c you\\u2019re missing Beauty and the Beast\\u002c Vampire Diaries &amp; Grey\\u2019s Anatomy right now on TV. Saturday is Merlin\\&quot;&quot; - @user #sisterlife&quot;&#39;,
        &#39;Decided to watch Rick and Morty will probably watch Naruto tomorrow such a good movie hits ya right in the feels&#39;,
        &quot;first Hasek now Modano want to come back...who&#39;s next Mario Lemieux for the 4th time!&quot;,
        &#39;@user isn\\u2019t it just!  staying in and watching the lovely James Martin on Saturday kitchen. Great pumpkin soup recipe to warm u up&#39;,
        &#39;@user how was your day today? Did you enjoy watching softball. We missed you on tiger woods&#39;,
        &#39;And to think I wrote this Dustin Johnson Tweet after the second round of the British Open&#39;,
        &quot;Just Turned the corner into Ghetto n #Roma 1st thing I saw a group of Muslims! Now that&#39;s tourism for ya. It&#39;s a sm world after all #peace&quot;,
        &quot;Be sure to look for Nash&#39;s new video with Skylynn tomorrow #NashNewVideo love you @user&quot;,
        &#39;Who wants to be my date to the White Sox vs Red Sox game Tuesday&#39;,
        &quot;At long last, Lexus has developed a hoverboard, the &#39;Slide,&#39; to be tested in public for the first time on Wed.&quot;,
        &#39;I noticed all the Huddlestone haters were conspicuous by their absence yesterday\\u002c particularly when he assisted Bale for the 1st goal #THFC&#39;,
        &#39;Unexpected development-- saw Ant-Man on Saturday night in London. It was surprisingly charming. I actually quite enjoyed it.&#39;,
        &#39;&quot;Tomorrow is Star Wars day! New movie! And is @user and @user birthday! Great, isn\&#39;t? @user&#39;,
        &#39;Sun is shining... Bob Marley on the radio... hiya Monday!&#39;,
        &#39;&quot;Hope, Love &amp;amp; Laughter; Warmth, Prosperity &amp;amp; Joy; A fragrant bouquet filled with life; You may Enjoy! A very happy Eid -&quot;&#39;,
        &quot;&#39;Frank Ocean&#39; appeared on Sunday 16 at the 11th place in the Top20 of Dallas-Ft. Worth&#39;s Trends: #trndnl&quot;],
       dtype=object),
 &#39;label&#39;: array([2, 1, 1, 1, 2, 2, 2, 0, 2, 1, 1, 1, 2, 0, 1, 1, 2, 2, 0, 1, 1, 2,
        1, 1, 1, 1, 1, 2, 2, 1, 1, 2, 1, 2, 2, 1, 1, 2, 1, 1, 2, 2, 0, 2,
        1, 1, 2, 2, 1, 1, 0, 2, 1, 2, 1, 2, 1, 1, 1, 0, 0, 2, 2, 2, 1, 1,
        0, 0, 1, 1, 1, 2, 1, 0, 1, 1, 2, 0, 2, 1, 2, 0, 2, 2, 2, 1, 0, 1,
        2, 2, 2, 1, 2, 1, 2, 0, 2, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2,
        0, 2, 0, 2, 1, 2, 1, 1, 1, 2, 1, 2, 0, 2, 2, 2, 2, 1]),
 &#39;embedding&#39;: array([[-0.11721872,  0.07510021,  0.00844238, ...,  0.05286286,
          0.06096685,  0.08142687],
        [-0.02556132, -0.01222771, -0.07829855, ...,  0.06099542,
         -0.01231135,  0.00749106],
        [-0.0092816 , -0.04148921,  0.01455652, ...,  0.07176238,
         -0.06872221, -0.01504247],
        ...,
        [-0.01190887,  0.04831458,  0.03302041, ..., -0.00753223,
         -0.08080895, -0.05962829],
        [-0.06194988,  0.15394783,  0.050227  , ...,  0.08113792,
          0.02496293, -0.06251295],
        [-0.02202111, -0.02095584, -0.02791084, ..., -0.10536157,
          0.03924675,  0.03357503]], shape=(128, 384), dtype=float32)}
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="run-inference-on-the-entire-dataset">
<h2>Run inference on the entire dataset<a class="headerlink" href="#run-inference-on-the-entire-dataset" title="Link to this heading">#</a></h2>
<p>Execute and materialize this dataset into object store memory. This operation will trigger execution of the lazy transformations performed on this dataset. The embedding model ‘TextEmbedder’ in map_batches() is called on the entire dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run inference on the entire dataset</span>
<span class="c1"># Note that this does not mutate the original Dataset.</span>
<span class="n">materialized_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "63b0ab43e93c4900a9008a1a130a1341", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5e40789bd09d4aabbbd7305887843f4c", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1271148a268b4d47a6b75e64c91ec165", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "a4245ae20232468e96b6aab8aaca4fd7", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># metadata after inference</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** Original dataset:&#39;</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">** Materialized dataset:&#39;</span><span class="p">,</span> <span class="n">materialized_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>** Original dataset: MapBatches(TextEmbedder)
+- Repartition
   +- Dataset(num_rows=45615, schema={text: string, label: int64})

** Materialized dataset: MaterializedDataset(
   num_blocks=2,
   num_rows=45615,
   schema={
      text: string,
      label: int64,
      embedding: numpy.ndarray(shape=(384,), dtype=float)
   }
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show a few rows of the materialized dataset with embeddings</span>
<span class="n">materialized_ds</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "eb609a2f22cb4e11ac21828265a198b5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "37cc4c88a3cc4bfeb6e4d12365ee8d41", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;text&#39;: &#39;&quot;QT @user In the original draft of the 7th book, Remus Lupin survived the Battle of Hogwarts. #HappyBirthdayRemusLupin&quot;&#39;, &#39;label&#39;: 2, &#39;embedding&#39;: array([-1.17218718e-01,  7.51002133e-02,  8.44237953e-03,  2.10537948e-02,
       -8.00926834e-02,  6.09376505e-02,  8.09841380e-02,  6.39745891e-02,
       -1.34842591e-02, -1.22891478e-02,  9.70130879e-03,  8.13238472e-02,
        1.59728657e-02, -6.84826868e-03, -7.90290013e-02, -2.23982316e-02,
       -5.93358018e-02,  4.27904241e-02, -5.25669474e-03, -4.10776436e-02,
       -3.37784477e-02, -2.12912727e-02,  1.09729558e-01,  2.08834168e-02,
        6.42482564e-02, -5.55025972e-02, -3.46165411e-02,  6.61124960e-02,
       -5.21334969e-02, -3.30999158e-02, -1.77784879e-02,  3.47602344e-03,
       -2.97606084e-02, -6.36240765e-02, -4.66033891e-02,  6.25401214e-02,
        2.89564747e-02, -5.32266051e-02,  5.21380231e-02, -1.88834351e-02,
       -3.40600796e-02,  1.02842702e-02, -2.32401919e-02,  6.98712543e-02,
        5.05110919e-02, -1.33760041e-02, -6.32564947e-02,  2.94806529e-02,
       -6.45845979e-02,  7.76715726e-02,  2.06234232e-02,  7.12174596e-03,
       -2.40456108e-02, -4.19275388e-02,  4.32918817e-02,  1.97234564e-02,
        6.78284839e-02, -5.84342591e-02,  6.50576949e-02, -6.35665376e-04,
       -9.23694149e-02,  6.70160577e-02,  1.61644816e-02,  8.81150190e-04,
       -1.06128380e-02, -1.53647423e-01, -6.23815991e-02,  1.25934454e-02,
       -1.15874708e-02, -3.37391533e-03, -1.45804777e-03, -1.68279577e-02,
        3.16142738e-02, -9.56896693e-03,  2.58824509e-02,  1.72043703e-02,
       -1.06465332e-02, -4.50892793e-03, -1.57877821e-02, -4.38858718e-02,
        4.12587933e-02, -1.05029851e-01, -9.40064341e-03, -1.93991698e-02,
        8.07769895e-02, -1.46954274e-02,  7.76875392e-03, -9.70078446e-03,
       -7.73954112e-03, -6.33768886e-02, -4.40336857e-03,  1.01402104e-02,
        6.79888725e-02,  6.40537590e-02,  3.94202918e-02,  4.05897461e-02,
       -5.73339425e-02, -1.31973000e-02, -1.77555919e-01,  1.75755769e-02,
        3.35890651e-02, -2.96707787e-02,  6.60929009e-02,  5.90833239e-02,
        7.71614686e-02, -4.89910729e-02, -1.19408388e-02, -2.27159020e-02,
       -5.01141734e-02, -1.46210968e-01, -6.56389399e-03, -1.15747452e-01,
        7.41516277e-02,  3.42241838e-04,  8.31499174e-02,  2.45558545e-02,
        1.50099332e-02,  1.08849846e-01, -5.23204021e-02, -7.37850042e-03,
        3.49425897e-02,  8.54113623e-02, -9.36829392e-03, -5.40084913e-02,
       -1.64574068e-02, -7.19670653e-02,  3.98440845e-03,  3.58003160e-33,
        4.58818898e-02, -1.07039157e-02, -7.70758316e-02,  8.17278847e-02,
       -2.80772168e-02,  7.00596860e-03,  5.23302741e-02, -3.55900936e-02,
       -2.84438897e-02, -5.47925606e-02, -4.97773625e-02, -2.41786465e-02,
        1.80584863e-02, -7.33728483e-02, -7.44769201e-02,  4.01951000e-02,
       -1.16273381e-01, -4.30478994e-03, -4.09788750e-02,  2.46128924e-02,
       -1.12685782e-03, -3.20175812e-02, -4.27514724e-02, -5.19986786e-02,
        4.28858958e-02,  4.66034375e-02,  3.08393911e-02,  6.15451038e-02,
        3.45387161e-02,  3.17677706e-02, -1.05951829e-02, -4.23053056e-02,
        4.84787306e-04, -2.49361154e-02, -8.93655512e-03, -2.25248020e-02,
       -5.19684739e-02, -1.04188204e-01,  1.68928802e-02,  4.78072055e-02,
       -5.54645248e-02,  1.28076579e-02, -1.21971425e-02, -7.01387227e-02,
       -2.46787928e-02,  7.94926137e-02,  2.89146360e-02,  1.02481507e-01,
        1.06039613e-01, -2.30980236e-02,  2.10956261e-02,  3.45463008e-02,
       -5.59060508e-03, -3.63363028e-02, -3.71677093e-02,  2.28330866e-03,
       -4.01646197e-02,  1.11712754e-01,  2.84649059e-02,  1.89326443e-02,
        2.30981060e-03,  6.20113872e-02, -1.37751494e-02,  2.03241184e-02,
       -2.80346647e-02, -7.75653571e-02, -4.14971709e-02, -7.20567256e-03,
       -4.97926176e-02,  2.63391770e-02, -5.86166140e-03, -2.06317782e-04,
        5.78927866e-04, -8.92704949e-02, -4.81969379e-02, -7.32145682e-02,
        4.31562141e-02,  5.28947487e-02, -9.46654081e-02, -7.99955577e-02,
        6.97478577e-02,  6.47439016e-03, -5.47678024e-02,  1.17145060e-03,
        6.50785267e-02, -6.31659403e-02,  3.60769555e-02, -1.34668782e-01,
        1.32890965e-03,  5.14443852e-02,  3.90151963e-02, -4.06383444e-03,
       -6.79656491e-02,  3.05412337e-02, -3.91437262e-02, -3.31172134e-33,
       -1.93256009e-02,  2.11085677e-02, -6.86359452e-03,  5.23793101e-02,
       -5.23960292e-02, -2.27106623e-02, -5.45928478e-02,  7.00129196e-02,
        1.41968962e-03, -5.32654747e-02,  3.35026570e-02,  5.39053045e-02,
       -4.56011016e-03,  1.05699580e-02,  1.02750473e-02, -1.76138058e-03,
       -4.18264270e-02,  7.87272584e-03,  9.69689246e-03, -2.13547181e-02,
       -2.16129310e-02, -2.17952654e-02, -8.20093006e-02, -2.54546804e-03,
        4.96112816e-02,  3.79144512e-02,  9.71367359e-02, -7.81605020e-02,
        2.14656349e-02, -5.85630648e-02,  1.49249397e-02, -8.17982033e-02,
       -7.98221380e-02, -4.16970104e-02,  6.06887527e-02, -2.16946062e-02,
        8.99340957e-02, -2.06241195e-04, -2.82704625e-02,  1.48663167e-02,
        9.76795331e-02,  4.07512747e-02,  3.91802080e-02,  1.84257627e-02,
        3.35833579e-02, -2.44072895e-03,  4.15428728e-02,  6.70849383e-02,
        1.69882979e-02,  5.21745682e-02, -2.44500265e-02, -6.58806413e-02,
        1.15585802e-02, -7.51119480e-02, -2.09318195e-02,  3.46736982e-03,
        3.93599756e-02, -9.12234001e-03,  2.78715137e-02, -3.19835320e-02,
       -7.81974494e-02, -2.90528610e-02,  3.26309279e-02,  3.06678507e-02,
        3.95409912e-02, -2.03319024e-02, -4.18165373e-03,  5.66712171e-02,
       -6.88231084e-03, -3.81209888e-02,  2.90659517e-02, -1.93396618e-03,
       -2.29473785e-02, -1.94511395e-02,  1.53534813e-02,  9.87687856e-02,
       -3.49257514e-02,  3.95493992e-02, -2.22867932e-02, -6.29297644e-03,
        8.33572224e-02,  2.73475703e-02, -3.66510823e-02,  3.77095975e-02,
        6.62408248e-02, -6.19172417e-02, -2.96917129e-02,  3.25294994e-02,
        3.17605399e-02, -6.35268092e-02,  5.86302094e-02,  9.55099240e-03,
        7.19797611e-02,  5.65288996e-04,  5.88193573e-02, -3.06202352e-08,
        4.70640138e-03,  1.02480531e-01, -2.98234466e-02, -9.26990714e-03,
        3.66888866e-02,  7.81677291e-02,  4.95807119e-02, -6.63496330e-02,
       -4.63559180e-02,  1.68990344e-01, -1.34740751e-02,  7.74639919e-02,
       -7.67530221e-03, -2.24219281e-02, -1.29715446e-02,  9.00719017e-02,
       -1.57175567e-02, -4.43267226e-02, -8.95755831e-03, -1.44299744e-02,
        3.72793153e-02,  1.30715715e-02,  9.86067504e-02,  2.01104600e-02,
       -4.95612733e-02,  6.32244647e-02,  5.00994138e-02, -4.25795130e-02,
       -4.42548003e-03, -4.18200418e-02,  6.43996522e-02,  1.28545947e-02,
       -1.49631714e-02, -6.33315668e-02, -6.71327189e-02,  6.92848936e-02,
       -4.39268537e-03,  5.62317707e-02,  6.82934299e-02,  2.83462293e-02,
       -5.08866049e-02,  5.43779554e-03,  8.86543170e-02,  1.91011913e-02,
       -5.92106171e-02, -5.94048835e-02, -1.15786707e-02, -5.75899668e-02,
       -1.15391724e-02, -5.88483773e-02, -6.32902160e-02, -6.89050034e-02,
        6.49331436e-02, -2.99487356e-02, -4.41985670e-03,  2.54450669e-03,
        2.28572544e-02,  4.88852262e-02,  3.76263633e-02, -6.22804798e-02,
        7.95309842e-02,  5.28628640e-02,  6.09668531e-02,  8.14268738e-02],
      dtype=float32)}
{&#39;text&#39;: &#39;&quot;Ben Smith / Smith (concussion) remains out of the lineup Thursday, Curtis #NHL #SJ&quot;&#39;, &#39;label&#39;: 1, &#39;embedding&#39;: array([-2.55613178e-02, -1.22277103e-02, -7.82985464e-02,  2.23083012e-02,
        4.47834991e-02,  9.60700288e-02,  6.89739510e-02,  1.91462375e-02,
        3.44326049e-02, -1.80058852e-02, -7.94921815e-02,  8.78439620e-02,
       -2.44877301e-02,  4.82736081e-02,  4.00641076e-02, -7.94008095e-03,
       -5.26009388e-02,  7.12939501e-02, -6.52135583e-03, -6.82709087e-03,
       -1.29825398e-01,  8.02508835e-03, -8.82670507e-02, -1.48856053e-02,
        5.56896329e-02,  6.38554320e-02, -1.19254841e-02, -2.13803817e-02,
       -8.43747482e-02,  1.26320729e-02, -4.74106744e-02, -1.50946071e-02,
        8.63529071e-02, -4.39660065e-02,  3.20312032e-03, -8.74198601e-03,
       -4.42857780e-02,  6.30582720e-02, -5.30618355e-02,  5.91205712e-03,
        3.80778313e-02,  4.53377999e-02, -5.43168001e-02, -2.31449399e-03,
        5.61808310e-02,  1.20103974e-02, -4.82929088e-02, -7.57502690e-02,
        5.07813133e-02,  6.22332841e-02,  3.17716263e-02, -7.45667797e-03,
        4.52154651e-02,  4.76346910e-02,  2.97699012e-02,  3.64353992e-02,
       -1.03162946e-02, -2.26502474e-02, -6.53998228e-03,  4.38563488e-02,
       -1.53381238e-02, -7.38687068e-02,  1.18025970e-02, -4.27902825e-02,
        3.20152864e-02,  1.69849765e-04, -7.02338964e-02, -2.94919703e-02,
       -5.24085984e-02,  5.06155156e-02,  5.58261052e-02,  4.48048115e-02,
       -9.27486494e-02, -2.99074054e-02, -1.43916206e-02,  9.60254669e-03,
        2.32722983e-03, -7.26314560e-02,  8.12841654e-02,  2.87622940e-02,
        3.61495838e-02, -7.20370263e-02, -3.91010717e-02,  4.62209135e-02,
        5.63077107e-02,  5.88136353e-02, -2.27219909e-02,  4.94449548e-02,
       -5.53754605e-02,  8.89227986e-02, -8.43940079e-02,  3.83486040e-02,
        1.23478852e-01, -1.62131321e-02,  5.37196398e-02,  1.14703774e-02,
       -1.28796948e-02, -3.82876396e-02, -9.97122377e-02,  6.26244992e-02,
        1.25175510e-02,  3.23107583e-03,  2.76067518e-02, -8.78041089e-02,
        1.04419766e-02, -1.30746688e-03, -2.71802861e-02, -3.36855166e-02,
        4.15072963e-03, -5.99537045e-02,  4.48855758e-02,  1.14159100e-01,
       -5.89613281e-02,  3.30517557e-03,  3.20716389e-02, -3.87823978e-03,
        2.39532143e-02,  7.92267558e-04,  6.68623075e-02, -4.79875319e-02,
        2.11493243e-02,  8.82634446e-02,  2.38798335e-02,  4.41922843e-02,
        1.60900429e-02,  5.62676229e-02, -1.37080820e-02, -1.52324782e-33,
        1.40510444e-02,  1.25912409e-02,  1.56041365e-02,  5.57393692e-02,
        2.67249476e-02, -4.11788076e-02,  1.36150215e-02, -8.49959813e-03,
       -4.08855490e-02, -6.99530393e-02, -2.27213278e-02, -1.71361454e-02,
        9.42177847e-02, -8.82237032e-02, -1.90656148e-02, -3.51617597e-02,
        5.87068461e-02, -1.54304842e-03,  3.76780378e-03, -5.22918031e-02,
       -5.45237213e-02, -1.76568236e-03, -7.63769671e-02,  3.08161136e-03,
       -3.69230062e-02, -2.68261507e-02, -1.76323075e-02, -6.73842654e-02,
       -3.03915609e-02,  1.09058516e-02, -5.56920916e-02,  1.28869668e-01,
        7.84609653e-03,  8.80600139e-02,  7.00087994e-02, -3.35481167e-02,
       -9.90392175e-03,  6.11897744e-02, -2.46281177e-02, -9.28131025e-03,
        3.00403815e-02,  1.66808441e-02, -9.37153175e-02, -1.46350823e-02,
       -5.96568063e-02,  1.21405767e-02,  2.86025219e-02,  7.83483610e-02,
        2.18932852e-02, -5.49808554e-02,  3.51315774e-02,  6.61210120e-02,
        1.81153491e-02,  2.04514116e-02, -9.43328887e-02,  1.73909385e-02,
        5.59438765e-02,  4.97128675e-03,  2.51865722e-02, -1.96423475e-03,
        1.33300245e-01,  1.53959617e-02, -8.91614705e-02,  8.85712914e-03,
       -2.07582638e-02, -4.13841531e-02, -7.87826851e-02, -1.19861914e-02,
       -4.14533243e-02, -1.92968845e-02,  2.61377022e-02,  5.39287962e-02,
       -9.38115362e-03,  6.85030222e-02, -5.84072098e-02,  1.24473451e-03,
       -6.05048873e-02,  1.36857450e-01, -3.39905545e-03,  3.11745796e-02,
        7.76972622e-02, -6.35873899e-02, -4.34449054e-02, -1.58614498e-02,
       -3.84016372e-02,  3.38910706e-03,  2.32756231e-02, -5.53193595e-03,
       -1.38496622e-01,  2.69974936e-02,  2.49307863e-02,  3.71107422e-02,
        5.30565623e-04, -1.60926636e-02, -3.14777484e-03, -2.76055871e-34,
       -9.78836194e-02, -1.46938870e-02, -7.27394149e-02,  2.06164196e-02,
        3.10279503e-02, -8.07614997e-02,  7.94474315e-03,  3.32296453e-02,
        7.23314434e-02, -3.07590961e-02,  6.15157820e-02, -4.93274853e-02,
       -8.39590132e-02,  3.49642932e-02,  4.63410094e-02, -1.90476887e-02,
       -8.16249922e-02,  7.04781413e-02, -5.39747020e-03, -8.58904049e-03,
        9.71276686e-02, -8.64927173e-02, -6.38451725e-02, -2.74092592e-02,
       -6.03620186e-02,  3.69485952e-02,  7.36873224e-02,  2.89384127e-02,
       -6.56188577e-02,  4.94507216e-02, -7.41920993e-02, -1.42943636e-02,
        1.66672035e-04, -9.95530374e-03, -4.00982723e-02,  3.37605290e-02,
       -5.95777296e-02,  6.70991046e-03, -1.57008413e-02,  3.73471044e-02,
        3.79455946e-02,  5.53716086e-02,  3.18707759e-03,  1.51786283e-01,
        7.76463524e-02,  1.42904809e-02,  5.78197911e-02,  4.46490431e-03,
       -1.10954670e-02,  3.20407227e-02, -5.73056117e-02, -7.25806283e-04,
       -7.94559568e-02,  3.97899076e-02, -4.93872128e-02, -1.19192507e-02,
       -1.98645657e-03, -7.47399181e-02, -5.22234142e-02, -1.06282867e-01,
       -9.44628939e-03,  4.59105931e-02,  1.49779003e-02, -1.83186028e-02,
        9.78474542e-02,  3.79409343e-02,  1.98250581e-02, -1.93877090e-02,
       -5.19630387e-02, -6.22458421e-02, -5.05403318e-02, -3.21796946e-02,
        7.79880509e-02, -5.00046369e-03, -4.84560393e-02,  1.87722724e-02,
       -4.44888324e-02,  2.35665385e-02,  1.78778227e-02,  2.74006203e-02,
       -1.57440994e-02, -3.61626707e-02, -6.27598614e-02,  5.92633970e-02,
        1.58189368e-02, -2.34323069e-02,  2.17458829e-02,  2.83414386e-02,
       -6.52647242e-02, -4.23069037e-02, -1.01103884e-04, -1.94980036e-02,
        1.46038486e-02,  8.76936167e-02, -8.81101489e-02, -2.34348310e-08,
       -5.31913936e-02, -3.84204574e-02, -1.30834863e-01, -3.89393270e-02,
        9.15531293e-02,  8.70207208e-04,  7.21508265e-02,  3.77374096e-03,
        9.15844142e-02,  3.65297012e-02, -3.70606668e-02,  1.32635012e-02,
       -2.73160497e-03, -4.00724374e-02,  4.21377383e-02,  4.44875658e-02,
       -9.84100178e-02, -3.10863163e-02, -1.36786141e-02, -5.65908886e-02,
       -1.04401015e-01,  1.89414667e-03, -1.74725649e-03,  3.48813944e-02,
        2.80134752e-02,  6.42856956e-02, -4.85674404e-02,  6.26258478e-02,
        3.54573391e-02, -1.47293536e-02,  1.23639209e-02,  6.23702966e-02,
        4.56662523e-03,  1.61783993e-02,  9.06857569e-03, -4.01875377e-02,
       -1.36868265e-02, -4.51042950e-02,  1.08593434e-01, -9.17549804e-02,
       -2.72664893e-02, -6.42662169e-03, -4.96078059e-02,  7.15247765e-02,
        6.12468980e-02, -2.39855982e-02,  3.41575071e-02,  3.28529142e-02,
       -6.83045536e-02, -1.24854468e-01, -1.72060728e-02, -2.08318681e-02,
        1.95717700e-02,  6.82900697e-02,  3.40240113e-02,  6.28125295e-02,
        8.68410710e-03, -5.08967713e-02, -2.17342269e-04, -5.02352677e-02,
       -3.67074795e-02,  6.09954223e-02, -1.23113478e-02,  7.49106100e-03],
      dtype=float32)}
{&#39;text&#39;: &#39;Sorry bout the stream last night I crashed out but will be on tonight for sure. Then back to Minecraft in pc tomorrow night.&#39;, &#39;label&#39;: 1, &#39;embedding&#39;: array([-9.28160176e-03, -4.14892137e-02,  1.45565206e-02, -8.35185423e-02,
        7.88125470e-02, -1.39421923e-02, -4.58531007e-02,  3.97312343e-02,
       -7.73005784e-02,  1.19767813e-02, -4.00974117e-02,  6.80779386e-03,
       -6.15553670e-02,  3.10526211e-02, -2.67168414e-03,  2.56718080e-02,
       -8.10807291e-03,  2.01351717e-02, -1.05955295e-01,  7.41280317e-02,
       -4.72918749e-02, -4.68044616e-02, -4.42471355e-02,  1.13586960e-02,
       -1.18926680e-02,  7.31019164e-03,  8.72505680e-02,  5.27818017e-02,
       -2.33023707e-02, -3.09640113e-02, -9.57536250e-02, -1.18500029e-03,
       -1.26816351e-02, -2.40409318e-02,  2.89740060e-02,  2.65101083e-02,
        2.42837034e-02, -2.03901269e-02,  1.64824829e-03, -2.51518283e-02,
        7.54621774e-02,  5.11016287e-02, -6.16848189e-03, -3.56115811e-02,
       -7.21600205e-02,  8.51503164e-02,  1.59831755e-02, -5.34999743e-02,
        6.00217544e-02,  1.03347346e-01, -5.25707304e-02, -5.24885803e-02,
        2.75378935e-02,  2.17306670e-02,  1.28086493e-03,  2.91938744e-02,
       -2.06012297e-02,  6.30638674e-02,  7.67096058e-02, -2.18252768e-03,
        5.29807210e-02, -5.36710434e-02, -1.47477984e-02,  3.15658525e-02,
        1.01958193e-01, -2.24984046e-02, -9.17503238e-03,  3.21776196e-02,
        3.12821269e-02, -2.82377563e-02, -3.95642184e-02,  2.62470581e-02,
       -5.04267104e-02, -5.34561165e-02, -9.26208720e-02,  4.50164117e-02,
        1.61173157e-02, -1.28749549e-01, -1.77606642e-02,  5.82819171e-02,
        3.07420641e-02, -9.28947702e-03, -8.07348490e-02, -3.60559933e-02,
       -6.85011083e-03, -1.41520910e-02, -1.73541475e-02,  1.04313433e-01,
        7.97910169e-02,  2.97468323e-02, -1.14019522e-02,  9.90668219e-03,
        7.12907687e-02,  1.58452298e-02, -2.38109175e-02,  1.05117615e-02,
        7.72602186e-02, -6.75087003e-03, -5.08386130e-03,  1.63008086e-02,
        8.83987024e-02,  5.79223316e-03,  1.43902507e-02,  2.57970206e-02,
        2.62782574e-02, -5.59260547e-02, -3.66871315e-03,  8.70502144e-02,
        6.40254933e-03, -6.49876371e-02, -3.90511677e-02,  4.14787792e-02,
        7.07005756e-03, -2.71599907e-02,  5.49026504e-02,  1.06359579e-01,
       -4.86110076e-02,  6.92230538e-02, -2.42604055e-02,  1.72232352e-02,
       -1.01544438e-02, -1.07735191e-02, -1.26948217e-02, -5.11058047e-02,
        9.76448804e-02,  6.84200376e-02,  2.25723777e-02,  6.43248991e-35,
        7.32454751e-03, -6.26351237e-02, -4.04127836e-02,  6.97651729e-02,
        1.08847059e-01, -9.73338448e-03,  7.00958297e-02,  1.52096841e-02,
       -3.87136489e-02, -2.70176884e-02,  2.95678936e-02, -5.12014441e-02,
       -5.13095595e-02, -4.07334603e-02, -8.59555081e-02, -3.13828215e-02,
        7.55923614e-02, -4.56688479e-02, -9.45596695e-02,  4.87503409e-02,
       -3.98070179e-02, -5.26156314e-02, -5.62014505e-02,  1.45803327e-02,
       -7.69655108e-02,  2.29535252e-02, -1.21584712e-02, -2.18899436e-02,
        3.46212946e-02,  2.07796153e-02, -6.07565679e-02, -7.80770779e-02,
       -2.63716504e-02,  1.81611199e-02,  4.50653918e-02, -2.36595646e-02,
       -1.03722222e-01, -1.41933542e-02, -1.13086134e-01, -5.26371822e-02,
        1.93267390e-02,  2.75361482e-02, -4.88547347e-02, -6.93108886e-02,
       -1.33832851e-02, -1.41709536e-01,  3.38281021e-02,  2.47783903e-02,
        2.21503563e-02, -2.30557770e-02, -1.72964428e-02,  8.39066431e-02,
        2.37764162e-03, -2.27935463e-02, -1.10879738e-03,  4.46190545e-03,
       -6.24192730e-02,  2.34613437e-02, -4.95128240e-03,  6.39796034e-02,
        2.01946776e-02,  5.57737350e-02,  7.97899440e-02, -1.58086956e-01,
        2.69690510e-02, -2.01505721e-02,  3.97603959e-02,  1.86763499e-02,
        5.12183236e-04, -5.84025085e-02,  2.22967193e-02,  2.96519734e-02,
        3.64042781e-02, -4.09158831e-03,  3.81992236e-02,  9.54230055e-02,
       -3.41169238e-02, -1.46371266e-02,  2.51320172e-02,  7.58155808e-02,
       -3.54291149e-03,  1.05031021e-02,  4.76404205e-02, -1.32373542e-01,
       -4.37142141e-02,  4.77830246e-02,  2.15556864e-02, -6.28415197e-02,
        2.90165711e-02,  2.52539432e-03, -1.19884178e-01,  1.67702921e-02,
        8.08926150e-02, -1.29964035e-02,  4.30540405e-02, -1.49187856e-33,
       -3.76389585e-02,  1.70480572e-02, -9.97973699e-03, -2.76702512e-02,
        3.40880044e-02, -4.40937243e-02,  5.09305708e-02,  8.44945610e-02,
       -4.93653901e-02, -5.67625724e-02, -7.82248098e-03, -9.26000811e-03,
       -1.28712449e-02,  2.40222309e-02, -4.32768166e-02, -1.10129036e-01,
       -1.34206163e-02,  2.51739728e-03,  3.32192443e-02,  2.78793629e-02,
       -5.87145798e-02, -3.75092961e-02, -1.92250460e-02,  1.93505753e-02,
        4.26429361e-02,  1.96230914e-02, -6.79288665e-03,  7.65683129e-02,
       -3.08306534e-02,  3.08888834e-02,  9.09694359e-02,  4.20587808e-02,
       -2.68863142e-02,  5.45977615e-02,  5.81750199e-02,  8.59733031e-04,
        7.85737485e-02, -2.00728178e-02,  1.43806068e-02, -2.88060308e-03,
        2.99445761e-04,  1.96223371e-02, -1.04279362e-01,  4.70483862e-02,
        3.43821533e-02,  5.97741865e-02,  2.01273207e-02,  1.25387060e-02,
       -2.16315296e-02, -3.37964366e-03,  5.47997355e-02,  1.73962507e-02,
        1.05964907e-01, -2.35189386e-02,  8.73528048e-02, -1.08117312e-01,
        1.01148352e-01, -2.31141504e-02, -1.67394597e-02, -5.98530062e-02,
       -1.05838008e-01, -1.03351809e-01, -3.96672040e-02,  4.51281480e-02,
        1.55635225e-02,  8.08900222e-02,  2.57156566e-02,  4.25258800e-02,
       -2.87305135e-02, -4.58301930e-03, -5.33827804e-02,  1.47896763e-02,
       -2.74435990e-02, -1.04760937e-02,  3.67200039e-02,  1.03974594e-02,
        5.51383309e-02,  2.80356482e-02, -3.77459675e-02,  1.33281359e-02,
        4.06659506e-02,  6.29792884e-02, -3.57226282e-02, -8.08423311e-02,
        1.12480514e-01, -6.56274483e-02,  8.19716156e-02,  8.39561000e-02,
       -1.01000227e-01, -5.75359203e-02, -2.35024523e-02,  2.04023737e-02,
       -3.35016027e-02,  2.55699139e-02,  5.16707636e-02, -2.47635157e-08,
       -3.07316985e-02, -3.44269560e-03, -4.59552705e-02,  1.04871886e-02,
        4.93218452e-02,  2.82714777e-02,  7.73386657e-03, -7.70623609e-02,
        1.47110615e-02,  4.44087312e-02, -2.66246349e-02, -8.97952076e-03,
       -2.92452052e-02,  4.84724203e-03,  2.41526775e-02, -8.97161290e-02,
       -5.31209707e-02, -3.75342406e-02,  1.25268223e-02, -5.02448604e-02,
        1.19601890e-01,  1.33688403e-02, -6.22192677e-03,  5.88282757e-02,
        5.99094741e-02,  6.88624009e-02,  5.57160601e-02,  6.46354072e-03,
       -5.55601753e-02, -4.85491417e-02, -5.22552105e-03,  2.33951919e-02,
        7.89891556e-02, -3.87155861e-02,  3.01616676e-02, -1.01347007e-02,
        2.88339034e-02, -7.21206143e-03,  2.96016713e-03,  6.87395632e-02,
        7.59349391e-03, -5.99006638e-02, -1.45630976e-02, -6.54685497e-02,
       -5.21637220e-03, -3.24615501e-02, -1.02316421e-02,  2.12832280e-02,
       -5.23694418e-02, -4.33163792e-02, -1.01848297e-01, -6.08562492e-02,
        2.72087287e-02, -1.84077434e-02,  1.33167297e-01, -5.71831726e-02,
        4.76900255e-03, -2.59980466e-02, -5.92608377e-02, -9.81385726e-03,
        8.45981687e-02,  7.17623755e-02, -6.87222108e-02, -1.50424745e-02],
      dtype=float32)}
</pre></div>
</div>
</div>
</div>
<section id="out-of-memory-errors">
<h3>Out of memory errors<a class="headerlink" href="#out-of-memory-errors" title="Link to this heading">#</a></h3>
<p>GPU (or MPS or CPU) memory has to keep the machine learning model and the batch of data in memory during the inference. If the batch_size is too large, it can run out of memory and throw out of memory errors. In that case, reduce the batch_size.</p>
</section>
<section id="shutdown-ray-cluster">
<h3>Shutdown Ray cluster<a class="headerlink" href="#shutdown-ray-cluster" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># avoids collisons with other notebooks running ray jobs on the same machine</span>
<span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h3>
<p>This notebook demonstrates how to perform efficient batch inference on large datasets using Ray Data. It walks through loading a public dataset from Hugging Face, converting it into a Ray Dataset, and defining a callable class to load and apply a machine learning model (SentenceTransformer) for embedding text. The notebook shows how to use Ray Data’s <code class="docutils literal notranslate"><span class="pre">map_batches</span></code> API to process data in parallel batches, leveraging available CPUs or GPUs for high-throughput inference. It also covers best practices for scaling, handling memory constraints, and summarizes how Ray Data enables scalable, distributed batch inference for modern ML workflows.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./courses/01_examples"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outline">Outline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import Libraries</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-a-dataset">Load a dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#batch-inference-class">Batch Inference Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-batch-data-and-call-the-model">Create a batch data and call the model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deploying-at-scale">Deploying at scale</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-inference-on-the-entire-dataset">Run inference on the entire dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#out-of-memory-errors">Out of memory errors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shutdown-ray-cluster">Shutdown Ray cluster</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book community
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>