
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Intro to Ray Data: Ray Data + Unstructured Data &#8212; Course Notebooks Test</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom_hide.css?v=af9667c8" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'courses/00_Developer_Intro_to_Ray/04c_Intro_Ray_Data_Unstructured';</script>
    <script src="../../_static/custom_toggle.js?v=1235ef5b"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Course Notebooks Test</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Ray Enablement Content
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Developer Intro to Ray</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="output/00_Intro_Ray_Core_Basics_01.html">Introduction to Ray Core: Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00_Intro_Ray_Core_Basics_02.html">0. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00_Intro_Ray_Core_Basics_03.html">1. Creating Remote Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00_Intro_Ray_Core_Basics_04.html">2. Executing Remote Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00_Intro_Ray_Core_Basics_05.html">3. Getting Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00_Intro_Ray_Core_Basics_06.html">4. Putting It All Together</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_01.html">Introduction to Ray Core (Advancement): Object store, Tasks, Actors</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_02.html">1. Object store</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_03.html">2. Chaining Tasks and Passing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_04.html">3. Task retries</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_05.html">4. Task Runtime Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_06.html">5. Resource allocation and management</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_07.html">6. Nested Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_08.html">7. Pattern: Pipeline data processing and waiting for results</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/00a_Intro_Ray_Core_Advancement_09.html">8. Ray Actors</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/01_Intro_Ray_AI_Libs_Overview_01.html">Introduction to the Ray AI Libraries: An example of using Ray data, Ray Train, Ray Tune, Ray Serve to implement a XGBoost regression model</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/01_Intro_Ray_AI_Libs_Overview_02.html">1. Overview of the Ray AI Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/01_Intro_Ray_AI_Libs_Overview_03.html">2. Quick end-to-end example</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02a_Intro_Ray_Train_with_PyTorch_01.html">Introduction to Ray Train + PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02a_Intro_Ray_Train_with_PyTorch_02.html">1. When to use Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02a_Intro_Ray_Train_with_PyTorch_03.html">2. Single GPU Training with PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02a_Intro_Ray_Train_with_PyTorch_04.html">3. Distributed Data Parallel Training with Ray Train and PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02a_Intro_Ray_Train_with_PyTorch_05.html">4. Ray Train in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02b_Intro_Ray_Train_with_PyTorch_Lightning_01.html">Introduction to Ray Train: Ray Train + PyTorch Lightning</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02b_Intro_Ray_Train_with_PyTorch_Lightning_02.html">1. When to use Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02b_Intro_Ray_Train_with_PyTorch_Lightning_03.html">2. Single GPU Training with PyTorch Lightning</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02b_Intro_Ray_Train_with_PyTorch_Lightning_04.html">3. Distributed Training with Ray Train and PyTorch Lightning</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/02b_Intro_Ray_Train_with_PyTorch_Lightning_05.html">4. Ray Train in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Intro_Ray_Tune_01.html">Introduction to Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Intro_Ray_Tune_02.html">1. Loading the data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Intro_Ray_Tune_03.html">2. Starting out with vanilla PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Intro_Ray_Tune_04.html">3. Hyperparameter tuning with Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/03_Intro_Ray_Tune_05.html">4. Ray Tune in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04a_Intro_Ray_Data_Industry_Landscape_01.html">Introduction to Ray Data: Industry Landscape</a></li>

<li class="toctree-l1"><a class="reference internal" href="output/04a_Intro_Ray_Data_Industry_Landscape_02.html">The Compute Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04a_Intro_Ray_Data_Industry_Landscape_03.html">The Orchestration Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04a_Intro_Ray_Data_Industry_Landscape_04.html">Distributed Computing Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04a_Intro_Ray_Data_Industry_Landscape_05.html">Data Processing with Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04a_Intro_Ray_Data_Industry_Landscape_06.html">Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_01.html">Introduction to Ray Data: Ray Data + Structured Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_02.html">0. What is Ray Data?</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_03.html">1. How to Use Ray Data?</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_04.html">2. Loading Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_05.html">3. Transforming Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_06.html">4. Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_07.html">5. Data Operations: Shuffling, Grouping and Aggregation</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_08.html">6. When to use Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_09.html">7. Ray Data in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04b_Intro_Ray_Data_Structured_10.html">8. Upcoming Features in Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_01.html">Intro to Ray Data:  Ray Data + Unstructured Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_02.html">1. When to Consider Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_03.html">2. How to work with Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_04.html">3. Loading data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_05.html">3. Lazy execution mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_06.html">4. Transforming data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_07.html">5. Stateful transformations with Ray Actors</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_08.html">6. Materializing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_09.html">7. Data Operations: grouping, aggregation, and shuffling</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_10.html">8. Persisting data</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/04c_Intro_Ray_Data_Unstructured_11.html">9. Ray Data in production</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/05_Intro_Ray_Serve_PyTorch_01.html">Introduction to Ray Serve with PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/05_Intro_Ray_Serve_PyTorch_02.html">1. When to Consider Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/05_Intro_Ray_Serve_PyTorch_03.html">2. Overview of Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/05_Intro_Ray_Serve_PyTorch_04.html">3. Implement an image classification service</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/05_Intro_Ray_Serve_PyTorch_05.html">4. Development workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="output/README_01.html">Introduction to Ray: Developer</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Anyscale 101</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_jobs_01.html">Content Used</a></li>

<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_jobs_02.html">Part 1. Creating and Submitting your first job</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_jobs_03.html">Part 2. Automation and Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_services_01.html">Sources</a></li>

<li class="toctree-l1"><a class="reference internal" href="../anyscale_101/output/101_anyscale_intro_services_02.html">Part 1: Starting your first Anyscale Service</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Ray 101</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/1_AI_Libs_Intro_01.html">Introduction to the Ray AI Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/1_AI_Libs_Intro_02.html">1. Overview of the Ray AI Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/1_AI_Libs_Intro_03.html">2. End-to-end example: predicting taxi tips in New York</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/1_AI_Libs_Intro_04.html">3. Running an experiment with Ray AI libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_01.html">Introduction to Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_02.html">1. PyTorch introductory example (single GPU)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_03.html">2. Distributed Data Parallel Training with Ray Train and PyTorch (multiple GPUs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_04.html">3. Overview of the training loop in Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_05.html">4. Migrating the model and dataset to Ray Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_06.html">5. Reporting checkpoints and metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_07.html">6. Launching the distributed training job</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_08.html">7. Accessing the training results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/2_Intro_Train_09.html">8. Ray Train in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_01.html">Intro to Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_02.html">1. Loading and visualizing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_03.html">2. Setting up a PyTorch model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_04.html">3. Introduction to Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_05.html">4. Diving deeper into Ray Tune concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/3_Intro_Tune_06.html">5. Hyperparameter tuning the PyTorch model using Ray Tune</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_01.html">Intro to Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_02.html">1. When to use Ray Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_03.html">2. Loading Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_04.html">3. Transforming Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_05.html">4. Data Operations: Grouping, Aggregation, and Shuffling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/4_Intro_Data_06.html">5. Persisting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_01.html">Intro to Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_02.html">1. Overview of Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_03.html">2. Implement an Classifier service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_04.html">3. Advanced features of Ray Serve</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_05.html">4. Ray Serve in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ray-101/output/5_Intro_Serve_06.html">Clean up</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/courses/00_Developer_Intro_to_Ray/04c_Intro_Ray_Data_Unstructured.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Intro to Ray Data:  Ray Data + Unstructured Data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-consider-ray-data">1. When to Consider Ray Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-work-with-ray-data">2. How to work with Ray Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data">3. Loading data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-on-blocks">2.2 Note on blocks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lazy-execution-mode">3. Lazy execution mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transforming-data">4. Transforming data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#on-resource-specification">4.1 On resource specification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#on-concurrency-limiting">4.2 On concurrency limiting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stateful-transformations-with-ray-actors">5. Stateful transformations with Ray Actors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resource-specification-for-stateful-transformations">5.1 Resource specification for stateful transformations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-on-autoscaling-for-stateful-transformations">5.2 Note on autoscaling for stateful transformations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#materializing-data">6. Materializing data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-operations-grouping-aggregation-and-shuffling">7. Data Operations: grouping, aggregation, and shuffling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-batching-using-groupby">7.1. Custom batching using <code class="docutils literal notranslate"><span class="pre">groupby</span></code>.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregations">7.2. Aggregations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shuffling-data">7.3. Shuffling data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#file-based-shuffle-on-read">7.3.1. File based shuffle on read</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#shuffling-block-order">7.3.2. Shuffling block order</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#shuffle-all-rows-globally">7.3.3. Shuffle all rows globally</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#persisting-data">8. Persisting data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ray-data-in-production">9. Ray Data in production</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="intro-to-ray-data-ray-data-unstructured-data">
<h1>Intro to Ray Data:  Ray Data + Unstructured Data<a class="headerlink" href="#intro-to-ray-data-ray-data-unstructured-data" title="Link to this heading">#</a></h1>
<p>© 2025, Anyscale. All Rights Reserved</p>
<p>💻 <strong>Launch Locally</strong>: You can run this notebook locally, but performance will be reduced.</p>
<p>🚀 <strong>Launch on Cloud</strong>: A Ray Cluster (Click <a class="reference external" href="http://console.anyscale.com/register">here</a> to easily start a Ray cluster on Anyscale) is recommended to run this notebook.</p>
<p>This notebook will provide an overview of Ray Data and how to use it to read, transform and write data in a distributed manner.</p>
<div class="alert alert-block alert-info">
<b> Here is the roadmap for this notebook:</b>
<ul>
  <li>When and why to use Ray Data?</li>
  <li>How to work with Ray Data</li>
  <li>Loading data</li>
  <li>Ray Data key concepts</li>
  <li>Lazy execution mode</li>
  <li>Transforming data</li>
  <li>Stateful transformations with Ray Actors</li>
  <li>Materializing data</li>
  <li>Data operations: grouping, aggregation, and shuffling</li>
  <li>Persisting data</li>
  <li>Ray Data in production</li>
</ul>
</div><p><strong>Imports</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">ToTensor</span><span class="p">,</span> <span class="n">Normalize</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ray</span>
</pre></div>
</div>
</div>
</div>
<section id="when-to-consider-ray-data">
<h2>1. When to Consider Ray Data<a class="headerlink" href="#when-to-consider-ray-data" title="Link to this heading">#</a></h2>
<p>Consider using Ray Data for your project if it meets one or more of the following criteria:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Challenge</strong></p></th>
<th class="head"><p><strong>Details</strong></p></th>
<th class="head"><p><strong>Ray Data Solution</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Operating on large datasets and/or models</strong></p></td>
<td><p>- Having to load and process massive datasets or models (e.g., &gt;10 TB) <br>- Having to perform inference with large models (e.g., LLMs) using inference engines</p></td>
<td><p>- Distributes data loading and processing across a Ray cluster <br>- Supports large model inference workloads via <a class="reference external" href="https://docs.ray.io/en/latest/data/working-with-llms.html">ray.data.llm</a></p></td>
</tr>
<tr class="row-odd"><td><p><strong>Efficient hardware utilization across CPUs and GPUs</strong></p></td>
<td><p>- Over-provisioning compute to naively partition data <br>- Performing static resource allocation <br>- Running execution in full across CPU and GPU stages <br>- Passing data between heteregenous stages by persisting intermediate results to disk</p></td>
<td><p>- <a class="reference external" href="https://docs.ray.io/en/latest/data/data-internals.html#streaming-execution">Streams data</a> to avoid full materialization in memory <br>- Enables resource multiplexing across pipeline stages <br>- Supports autoscaling for both CPU and GPU resources <br>- Enables pipeline parallelism across heterogeneous hardware with <a class="reference external" href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.map_batches.html#ray-data-dataset-map-batches">configurable batch sizes</a></p></td>
</tr>
<tr class="row-even"><td><p><strong>Building reliable pipelines</strong></p></td>
<td><p>- Needing to handle failures such as network errors, spot instance preemptions, and hardware faults</p></td>
<td><p>- Leverages <a class="reference external" href="https://docs.ray.io/en/latest/ray-core/fault-tolerance.html">Ray Core’s fault-tolerance mechanisms</a> to recover from failed tasks <br>- Supports <a class="reference external" href="https://docs.anyscale.com/rayturbo/rayturbo-data/#job-level-checkpointing">driver checkpointing</a> (via RayTurbo) for comprehensive pipeline reliability</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Handling unstructured data efficiently</strong></p></td>
<td><p>- Suboptimal resource allocation due to data skew in input data sizes (e.g. vary input video lengths)</p></td>
<td><p>- Automatically <a class="reference external" href="https://docs.ray.io/en/latest/data/data-internals.html">reshapes data into uniformly sized blocks</a> to improve processing efficiency</p></td>
</tr>
</tbody>
</table>
</div>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head text-left"><p><img src="https://docs.ray.io/en/releases-2.6.1/_images/stream-example.png" width="70%" loading="lazy"></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>Example batch inference pipeline with Ray Data over a large dataset using heterogeneous cluster of CPUs and GPUs.</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="how-to-work-with-ray-data">
<h2>2. How to work with Ray Data<a class="headerlink" href="#how-to-work-with-ray-data" title="Link to this heading">#</a></h2>
<p>It is commonly a three step process when using Ray Data:</p>
<ol class="arabic simple">
<li><p>Create your Dataset (most commonly using an IO connector)</p></li>
<li><p>Apply transformations to your Dataset</p></li>
<li><p>Consume your Dataset by either:</p>
<ol class="arabic simple">
<li><p>Writing it out to a sink (file-based or database)</p></li>
<li><p>Iterating over it (connecting it to a training process)</p></li>
</ol>
</li>
</ol>
</section>
<section id="loading-data">
<h2>3. Loading data<a class="headerlink" href="#loading-data" title="Link to this heading">#</a></h2>
<p>Let’s load some <code class="docutils literal notranslate"><span class="pre">MNIST</span></code> data from s3.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here is our dataset it contains 50 images per class</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>ls<span class="w"> </span>s3://anyscale-public-materials/ray-ai-libraries/mnist/50_per_index/
</pre></div>
</div>
</div>
</div>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">read_images</span></code> function to load the image data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_images</span><span class="p">(</span><span class="s2">&quot;s3://anyscale-public-materials/ray-ai-libraries/mnist/50_per_index/&quot;</span><span class="p">,</span> <span class="n">include_paths</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
  <p><strong>Ray Data supports a variety of data sources for loading data</strong></p>
  <ul>
    <li>
      Reading files from common file formats (e.g. Parquet, CSV, JSON, etc.)
      <ul>
          <li><code>ds = ray.data.read_parquet("s3://...")</code></li>
      </ul>
    </li>
    <li>Loading from in-memory data structures (e.g. NumPy, PyTorch, etc.)
      <ul>
          <li><code>ray.data.from_torch(torch_ds)</code></li>
      </ul>
    <li>Loading from data lakehouses and warehouses such as Snowflake, Iceberg, and Databricks.</li>
      <ul>
          <li><code>ds = ray.data.read_databricks_tables()</code></li>
      </ul>
  </ul>
  <p>
    Start with an extensive list of <a href="https://docs.ray.io/en/latest/data/api/input_output.html#input-output" target="_blank">supported formats</a> and review further options in our <a href="https://docs.ray.io/en/latest/data/loading-data.html#loading-data" target="_blank">data loading guide</a>.
  </p>
</div><p>Under the hood, Ray Data uses Ray tasks to read data from remote storage</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head text-left"><p><img src="https://anyscale-materials.s3.us-west-2.amazonaws.com/ray-data-deep-dive/Ray+Data+Internals+-+reading.png" width="500px" loading="lazy"></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>When reading from a file-based datasource, Ray Data starts with a number of read tasks proportional to the number of CPUs in the cluster.</p></td>
</tr>
<tr class="row-odd"><td class="text-left"><p>Each read task reads its assigned files and produces output blocks.</p></td>
</tr>
</tbody>
</table>
</div>
<section id="note-on-blocks">
<h3>2.2 Note on blocks<a class="headerlink" href="#note-on-blocks" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head text-left"><p><img src="https://assets-training.s3.us-west-2.amazonaws.com/ray-intro/block.png" width="700px" loading="lazy"></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-left"><p>A Dataset when materialized is a distributed collection of blocks. This example illustrates a materialized dataset with three blocks, each block holding 1000 rows.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="alert alert-block alert-info">
<strong>Block</strong> is a contiguous subset of rows from a dataset. Blocks are distributed across the cluster and processed independently in parallel. By default blocks are PyArrow tables.
</div></section>
</section>
<section id="lazy-execution-mode">
<h2>3. Lazy execution mode<a class="headerlink" href="#lazy-execution-mode" title="Link to this heading">#</a></h2>
<p>In Ray Data, operations are not executed immediately. Most transformations are <strong>lazy</strong>, meaning they build up an execution plan rather than running right away.</p>
<p>The execution plan is only <strong>executed</strong> when you call a method that <em>materializes</em> or <em>consumes</em> the dataset.</p>
<p>To materialize a small subset of the data, you can use the <code class="docutils literal notranslate"><span class="pre">take_batch</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">take_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">batch</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize an example image:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Note on execution triggering methods in Ray Dataset</b></p>
<p>To determine if an operation will trigger execution, look for the methods with the <code class="docutils literal notranslate"><span class="pre">ConsumptionAPI</span></code> decorator in the <a class="reference external" href="https://github.com/ray-project/ray/blob/master/python/ray/data/dataset.py"><code class="docutils literal notranslate"><span class="pre">Dataset.py</span></code></a>.</p>
<p>These categories of operations trigger execution (with some examples):</p>
<ul class="simple">
<li><p>Method designed to consume Datasets for <strong>writing</strong>:</p>
<ul>
<li><p><a class="reference external" href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.write_parquet.html#ray.data.Dataset.write_parquet"><code class="docutils literal notranslate"><span class="pre">write_parquet</span></code></a></p></li>
</ul>
</li>
<li><p>Method designed to consume Datasets for <strong>distributed training</strong>:</p>
<ul>
<li><p><a class="reference external" href="https://github.com/ray-project/ray/blob/master/python/ray/data/dataset.py#L1694"><code class="docutils literal notranslate"><span class="pre">streaming_split</span></code></a></p></li>
</ul>
</li>
<li><p>Methods that attempt to <strong>show</strong> data, for example:</p>
<ul>
<li><p><a class="reference external" href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.take.html#ray.data.Dataset.take"><code class="docutils literal notranslate"><span class="pre">take</span></code></a></p></li>
<li><p><a class="reference external" href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.show.html#ray-data-dataset-show"><code class="docutils literal notranslate"><span class="pre">show</span></code></a></p></li>
</ul>
</li>
<li><p><strong>Aggregations</strong>, which attempt to reduce a dataset to a single value per column:</p>
<ul>
<li><p><a class="reference external" href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.min.html#ray.data.Dataset.min"><code class="docutils literal notranslate"><span class="pre">min</span></code></a></p></li>
<li><p><a class="reference external" href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.sum.html#ray.data.Dataset.sum"><code class="docutils literal notranslate"><span class="pre">sum</span></code></a></p></li>
</ul>
</li>
</ul>
<p>Another way to trigger execution is to explicitly call <a href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.materialize.html#ray-data-dataset-materialize" target="_blank">materialize()</a>. This will execute the underlying plan and generate the entire data blocks onto the cluster’s memory.</p>
</section>
<section id="transforming-data">
<h2>4. Transforming data<a class="headerlink" href="#transforming-data" title="Link to this heading">#</a></h2>
<p>To transform data, we can use the <a class="reference external" href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.map_batches.html#ray-data-dataset-map-batches"><code class="docutils literal notranslate"><span class="pre">map_batches</span></code></a> API.</p>
<p><code class="docutils literal notranslate"><span class="pre">map_batches</span></code> takes a user-defined function which accepts a batch of data and returns a batch of transformed data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,))])</span>
    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">batch</span>
</pre></div>
</div>
</div>
</div>
<p>Calling <code class="docutils literal notranslate"><span class="pre">ds.map_batches</span></code> will add a <code class="docutils literal notranslate"><span class="pre">map_batches</span></code> operator to the execution plan.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_normalized</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">normalize</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To tune the batch size for the transformation, specify the <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> parameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_normalized</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><strong>Note:</strong> batching only helps with performance when a transformation is vectorized - i.e. benefits from processing multiple rows at once.</p>
<p>Finding the optimal batch size depends on the hardware available and the target utilization.</p>
</div><section id="on-resource-specification">
<h3>4.1 On resource specification<a class="headerlink" href="#on-resource-specification" title="Link to this heading">#</a></h3>
<p>To specify the exact resources to use for a <code class="docutils literal notranslate"><span class="pre">map_batches</span></code> transformation, specify the <code class="docutils literal notranslate"><span class="pre">num_cpus</span></code>, <code class="docutils literal notranslate"><span class="pre">num_gpus</span></code>, <code class="docutils literal notranslate"><span class="pre">memory</span></code>, and <code class="docutils literal notranslate"><span class="pre">resources</span></code> parameters.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">num_cpus</span></code>: Number of CPUs to use for each task (use &gt;1 if task performs multithreaded operations).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_gpus</span></code>: Number of GPUs to use for each task.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memory</span></code>: Amount of RAM to use for each task (in bytes).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resources</span></code>: What is referred to as custom resources in Ray. It is a way to specify which node types to use for each task.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_normalized</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">num_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><strong>Note:</strong> Ray only performs a logical allocation of resources and does not physically enforce resource limits.</p>
<p>By default, Ray will <a class="reference external" href="https://docs.ray.io/en/latest/ray-core/scheduling/ray-oom-prevention.html#retry-policy">retry OOM errors</a> and Ray Data will infinitely retry tasks that fail due to system failures.</p>
<p>Specifying resources helps avoid resource contention, avoiding unnecessary retries and confusing OOM errors.</p>
</div></section>
<section id="on-concurrency-limiting">
<h3>4.2 On concurrency limiting<a class="headerlink" href="#on-concurrency-limiting" title="Link to this heading">#</a></h3>
<p>Ray Data will attempt to use all the resources available in the cluster.</p>
<p>In particular, it will schedule as many tasks as there are input blocks for each operator (stage) in the pipeline.</p>
<p>To limit the concurrency for a particular transformation, specify the <code class="docutils literal notranslate"><span class="pre">concurrency</span></code> parameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concurrency_limit</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Don&#39;t schedule more than 10 tasks at a time</span>

<span class="n">ds_normalized</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span>
    <span class="n">normalize</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">num_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">memory</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">concurrency</span><span class="o">=</span><span class="n">concurrency_limit</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><strong>Note:</strong> Limiting concurrency might be helpful when you have an unbounded compute configuration (max number of nodes is too high) and you want to avoid aggressive scaling for a fast step in the pipeline (e.g. light preprocessing of data).</p>
<p>Additionally, note that Ray Data will attempt to fuse transformations together to reduce data transfer between stages. Setting different concurrency limits for different transformations might prevent this optimization.</p>
</div><p>To verify the output of <code class="docutils literal notranslate"><span class="pre">normalize()</span></code>, call <a class="reference external" href="https://docs.ray.io/en/latest/data/api/doc/ray.data.Dataset.take_batch.html#ray.data.Dataset.take_batch"><code class="docutils literal notranslate"><span class="pre">take_batch()</span></code></a> on the dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">normalized_batch</span> <span class="o">=</span> <span class="n">ds_normalized</span><span class="o">.</span><span class="n">take_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check the normalized pixel value range:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">normalized_batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]:</span>
    <span class="k">assert</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span> <span class="c1"># channel, height, width</span>
    <span class="k">assert</span> <span class="n">image</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="c1"># normalized to [-1, 1]</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><strong>Activity</strong></p>
<p>Add the ground truth label extracted from the image path.</p>
<p>Starting point:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_images</span><span class="p">(</span><span class="s2">&quot;s3://anyscale-public-materials/ray-ai-libraries/mnist/50_per_index/&quot;</span><span class="p">,</span> <span class="n">include_paths</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_normalized</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">normalize</span><span class="p">)</span>
<span class="c1"># batch = ds_normalized.take_batch(batch_size=3)</span>

<span class="c1"># add_label</span>
<span class="n">ds_labeled</span> <span class="o">=</span> <span class="n">ds_normalized</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">add_label</span><span class="p">)</span>
<span class="n">labeled_batch</span> <span class="o">=</span> <span class="n">ds_labeled</span><span class="o">.</span><span class="n">take_batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labeled_batch</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>The task</strong></p>
<p>Implement <code class="docutils literal notranslate"><span class="pre">add_label</span></code> function that takes batch of data and return batch with image label.</p>
<p>The image path is in the format:<code class="docutils literal notranslate"><span class="pre">s3://anyscale-public-materials/ray-ai-libraries/mnist/50_per_index/{label}/{image_id}.png</span></code>.</p>
<p><strong>Hint</strong>: Define the add_label function; use <code class="docutils literal notranslate"><span class="pre">take_batch()</span></code> to better understand the data format.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">add_label</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">batch</span>
</pre></div>
</div>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Write your solution here</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<details>
<summary>Click to view solution</summary>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">add_label</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batch</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_images</span><span class="p">(</span><span class="s2">&quot;s3://anyscale-public-materials/ray-ai-libraries/mnist/50_per_index/&quot;</span><span class="p">,</span> <span class="n">include_paths</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_normalized</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">normalize</span><span class="p">)</span>
<span class="n">ds_labeled</span> <span class="o">=</span> <span class="n">ds_normalized</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">add_label</span><span class="p">)</span>
<span class="n">labeled_batch</span> <span class="o">=</span> <span class="n">ds_labeled</span><span class="o">.</span><span class="n">take_batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labeled_batch</span><span class="p">)</span>
</pre></div>
</div>
</details>  
</div></section>
</section>
<section id="stateful-transformations-with-ray-actors">
<h2>5. Stateful transformations with Ray Actors<a class="headerlink" href="#stateful-transformations-with-ray-actors" title="Link to this heading">#</a></h2>
<p>In cases like batch inference, you want to spin up a number of actor processes that are <strong>initialized once</strong> with your model <strong>and reused</strong> to process multiple batches.</p>
<p>To implement this, you can use the <code class="docutils literal notranslate"><span class="pre">map_batches</span></code> API with a “Callable” class method that implements:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code>: Initialize any expensive state.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__call__</span></code>: Perform the stateful transformation.</p></li>
</ul>
<p>For example, we can implement a <code class="docutils literal notranslate"><span class="pre">MNISTClassifier</span></code> that:</p>
<ul class="simple">
<li><p>loads a pre-trained model from a local file</p></li>
<li><p>accepts a batch of images and generates the predicted label</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span> <span class="c1"># or &quot;cpu&quot; if you want to run it locally on CPU</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MNISTClassifier</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">local_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aws s3 cp --no-sign-request </span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;predicted_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span>
</pre></div>
</div>
</div>
</div>
<p>We can now use the <code class="docutils literal notranslate"><span class="pre">map_batches</span></code> API to apply the transformation to each batch of data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">storage_folder</span> <span class="o">=</span> <span class="s1">&#39;mnt/cluster_storage&#39;</span>  <span class="c1"># Modify this path to your local folder if it runs on your local environment</span>
<span class="n">local_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">storage_folder</span><span class="si">}</span><span class="s2">/model.pt&quot;</span>

<span class="n">mnist_classifier_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;remote_path&quot;</span><span class="p">:</span> <span class="s2">&quot;s3://anyscale-public-materials/ray-ai-libraries/mnist/model/model.pt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;local_path&quot;</span><span class="p">:</span> <span class="n">local_path</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ds_preds</span> <span class="o">=</span> <span class="n">ds_normalized</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span>
    <span class="n">MNISTClassifier</span><span class="p">,</span>
    <span class="n">fn_constructor_kwargs</span><span class="o">=</span><span class="n">mnist_classifier_args</span><span class="p">,</span>
    <span class="n">num_gpus</span><span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Use GPU if available</span>
    <span class="n">concurrency</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="resource-specification-for-stateful-transformations">
<h3>5.1 Resource specification for stateful transformations<a class="headerlink" href="#resource-specification-for-stateful-transformations" title="Link to this heading">#</a></h3>
<p>It is common when you have varying hardware types in your cluster to want to further specify which accelerators to use for each stage of your pipeline.</p>
<p>Let’s show how to achieve this with the <code class="docutils literal notranslate"><span class="pre">resources</span></code> parameter.</p>
<p>To use a GPU for following examples, we suggest to run them on Anyscale Ray Cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_preds</span> <span class="o">=</span> <span class="n">ds_normalized</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span>
    <span class="n">MNISTClassifier</span><span class="p">,</span>
    <span class="n">fn_constructor_kwargs</span><span class="o">=</span><span class="n">mnist_classifier_args</span><span class="p">,</span>
    <span class="n">num_gpus</span><span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Use GPU if available</span>
    <span class="n">concurrency</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">resources</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;accelerator_type:T4&quot;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Note:</b> Pass in the Callable class uninitialized. Your driver will not execute the class constructor. Ray will pass in the arguments to the class constructor when the class is actually used in a transformation.</p>
</div></section>
<section id="note-on-autoscaling-for-stateful-transformations">
<h3>5.2 Note on autoscaling for stateful transformations<a class="headerlink" href="#note-on-autoscaling-for-stateful-transformations" title="Link to this heading">#</a></h3>
<p>For stateless transformations, Ray Data will automatically scale up the number of tasks to match the number of input blocks.</p>
<p>For stateful transformations, Ray Data will schedule tasks proportional to the number of actors (workers) in the pool.</p>
<p>To specify an autoscaling pool, use a tuple of <code class="docutils literal notranslate"><span class="pre">(min_size,</span> <span class="pre">max_size)</span></code> for the <code class="docutils literal notranslate"><span class="pre">concurrency</span></code> parameter.</p>
<p>Ray Data will start with <code class="docutils literal notranslate"><span class="pre">min_size</span></code> actors and automatically scale up to <code class="docutils literal notranslate"><span class="pre">max_size</span></code> as needed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_preds</span> <span class="o">=</span> <span class="n">ds_normalized</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span>
    <span class="n">MNISTClassifier</span><span class="p">,</span>
    <span class="n">fn_constructor_kwargs</span><span class="o">=</span><span class="n">mnist_classifier_args</span><span class="p">,</span>
    <span class="n">num_gpus</span><span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Use GPU if available</span>
    <span class="n">concurrency</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># Autoscale pool based on blocks, resources and limits</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="c1">#resources={&quot;accelerator_type:T4&quot;: 0.0001}, # Optional if you run it locally</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_preds</span> <span class="o">=</span> <span class="n">ds_preds</span><span class="o">.</span><span class="n">take_batch</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">batch_preds</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="materializing-data">
<h2>6. Materializing data<a class="headerlink" href="#materializing-data" title="Link to this heading">#</a></h2>
<p>You can choose to materialize the entire dataset into the Ray object store which is distributed across the cluster, primarily in memory and secondarily spilling to disk.</p>
<p>To materialize the dataset, we can use the <code class="docutils literal notranslate"><span class="pre">materialize()</span></code> method.</p>
<p>Use this <strong>only</strong> when you require the full dataset to compute downstream outputs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_preds</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">materialize()</span></code> triggers the execution. The logs should show the execution plan of Dataset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Execution</span> <span class="n">plan</span> <span class="n">of</span> <span class="n">Dataset</span><span class="p">:</span> <span class="n">InputDataBuffer</span><span class="p">[</span><span class="n">Input</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">TaskPoolMapOperator</span><span class="p">[</span><span class="n">ListFiles</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">TaskPoolMapOperator</span><span class="p">[</span><span class="n">ReadFiles</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">TaskPoolMapOperator</span><span class="p">[</span><span class="n">MapBatches</span><span class="p">(</span><span class="n">normalize</span><span class="p">)]</span> <span class="o">-&gt;</span> <span class="n">ActorPoolMapOperator</span><span class="p">[</span><span class="n">MapBatches</span><span class="p">(</span><span class="n">MNISTClassifier</span><span class="p">)]</span>
</pre></div>
</div>
</section>
<section id="data-operations-grouping-aggregation-and-shuffling">
<h2>7. Data Operations: grouping, aggregation, and shuffling<a class="headerlink" href="#data-operations-grouping-aggregation-and-shuffling" title="Link to this heading">#</a></h2>
<p>Let’s look at some more involved transformations.</p>
<p>Some operations require all inputs to be materialized in object store. To determinte this, look for the methods with the <code class="docutils literal notranslate"><span class="pre">AllToAllAPI</span></code> decorator in the <a class="reference external" href="https://github.com/ray-project/ray/blob/master/python/ray/data/dataset.py"><code class="docutils literal notranslate"><span class="pre">Dataset.py</span></code></a>.</p>
<section id="custom-batching-using-groupby">
<h3>7.1. Custom batching using <code class="docutils literal notranslate"><span class="pre">groupby</span></code>.<a class="headerlink" href="#custom-batching-using-groupby" title="Link to this heading">#</a></h3>
<p>In case you want to generate batches according to a specific key, you can use <code class="docutils literal notranslate"><span class="pre">groupby</span></code> to group the data by the key and then use <code class="docutils literal notranslate"><span class="pre">map_groups</span></code> to apply the transformation.</p>
<p>For instance, let’s compute the accuracy of the model by “ground truth label”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">add_label</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;ground_truth_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">batch</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_accuracy</span><span class="p">(</span><span class="n">group</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;predicted_label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;ground_truth_label&quot;</span><span class="p">])],</span>
        <span class="s2">&quot;ground_truth_label&quot;</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;ground_truth_label&quot;</span><span class="p">][:</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_preds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">add_label</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;ground_truth_label&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_groups</span><span class="p">(</span><span class="n">compute_accuracy</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>Note:</b> <code class="docutils literal notranslate"><span class="pre">ds_preds</span></code> is not re-computed given we have already materialized the dataset.</p>
</div></section>
<section id="aggregations">
<h3>7.2. Aggregations<a class="headerlink" href="#aggregations" title="Link to this heading">#</a></h3>
<p>Ray Data also supports a variety of aggregations. For instance, we can compute the mean accuracy across the entire dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_preds</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">add_label</span><span class="p">)</span><span class="o">.</span><span class="n">map_batches</span><span class="p">(</span><span class="n">compute_accuracy</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note: this is ConsumptionAPI</p>
<p>Ray Data provides collection of aggregation functions including:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">count</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mean</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sum</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">std</span></code></p></li>
</ul>
<p>See relevant <a class="reference external" href="https://docs.ray.io/en/latest/data/api/grouped_data.html#ray.data.aggregate.AggregateFn">docs page here</a>.</p>
</section>
<section id="shuffling-data">
<h3>7.3. Shuffling data<a class="headerlink" href="#shuffling-data" title="Link to this heading">#</a></h3>
<p>There are different options to shuffle data in Ray Data of varying degrees of randomness and performance.</p>
<section id="file-based-shuffle-on-read">
<h4>7.3.1. File based shuffle on read<a class="headerlink" href="#file-based-shuffle-on-read" title="Link to this heading">#</a></h4>
<p>To randomly shuffle the ordering of input files before reading, call a read function that supports shuffling, such as <code class="docutils literal notranslate"><span class="pre">read_images()</span></code>, and use the shuffle=”files” parameter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read_images</span><span class="p">(</span><span class="s2">&quot;s3://anyscale-public-materials/ray-ai-libraries/mnist/50_per_index/&quot;</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="s2">&quot;files&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="shuffling-block-order">
<h4>7.3.2. Shuffling block order<a class="headerlink" href="#shuffling-block-order" title="Link to this heading">#</a></h4>
<p>This option randomizes the order of blocks in a dataset. Blocks are the basic unit of data chunk that Ray Data stores in the object store. Applying this operation alone doesn’t involve heavy computation and communication. However, it requires Ray Data to materialize all blocks in memory before applying the operation. Only use this option when your dataset is small enough to fit into the object store memory.</p>
<p>To perform block order shuffling, use <code class="docutils literal notranslate"><span class="pre">randomize_block_order</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_randomized_blocks</span> <span class="o">=</span> <span class="n">ds_preds</span><span class="o">.</span><span class="n">randomize_block_order</span><span class="p">()</span>
<span class="n">ds_randomized_blocks</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="shuffle-all-rows-globally">
<h4>7.3.3. Shuffle all rows globally<a class="headerlink" href="#shuffle-all-rows-globally" title="Link to this heading">#</a></h4>
<p>To randomly shuffle all rows globally, call <code class="docutils literal notranslate"><span class="pre">random_shuffle()</span></code>. This is the slowest option for shuffle, and requires transferring data across network between workers. This option achieves the best randomness among all options.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_randomized_rows</span> <span class="o">=</span> <span class="n">ds_preds</span><span class="o">.</span><span class="n">random_shuffle</span><span class="p">()</span>
<span class="n">ds_randomized_rows</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="persisting-data">
<h2>8. Persisting data<a class="headerlink" href="#persisting-data" title="Link to this heading">#</a></h2>
<p>Finally, you can persist a dataset to storage using any of the “write” functions that Ray Data supports.</p>
<p>Lets write our predictions to a parquet dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">local_pred_folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">storage_folder</span><span class="si">}</span><span class="s2">/mnist_preds&quot;</span> <span class="c1"># Change this to your local path if needed</span>
<span class="n">ds_preds</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="n">local_pred_folder</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Refer to the <a class="reference external" href="https://docs.ray.io/en/latest/data/api/input_output.html">Input/Output docs</a> for a comprehensive list of write functions.</p>
</section>
<section id="ray-data-in-production">
<h2>9. Ray Data in production<a class="headerlink" href="#ray-data-in-production" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Netflix is using Ray Data for multi-modal inference pipelines. See <a class="reference external" href="https://raysummit.anyscale.com/flow/anyscale/raysummit2024/landing/page/sessioncatalog/session/1722028596844001bCg0">this talk at the Ray Summit 2024</a> to learn more.</p></li>
<li><p>Pinterest is using Ray Data and Ray Train for their recommendation system model training. They leverage Ray Data to improve GPU utilization and training throughput by disaggregating their compute across a heterogeneous cluster.  <a class="reference external" href="https://www.classcentral.com/course/youtube-pinterest-s-ml-evolution-distributed-training-with-ray-ray-summit-2024-353672">this talk at the Ray Summit 2024</a> to learn more.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run this cell for file cleanup </span>
<span class="o">!</span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="o">{</span>storage_folder<span class="o">}</span>/mnist_preds
<span class="o">!</span>rm<span class="w"> </span><span class="o">{</span>storage_folder<span class="o">}</span>/model.pt
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./courses/00_Developer_Intro_to_Ray"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-consider-ray-data">1. When to Consider Ray Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-work-with-ray-data">2. How to work with Ray Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data">3. Loading data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-on-blocks">2.2 Note on blocks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lazy-execution-mode">3. Lazy execution mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transforming-data">4. Transforming data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#on-resource-specification">4.1 On resource specification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#on-concurrency-limiting">4.2 On concurrency limiting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stateful-transformations-with-ray-actors">5. Stateful transformations with Ray Actors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resource-specification-for-stateful-transformations">5.1 Resource specification for stateful transformations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#note-on-autoscaling-for-stateful-transformations">5.2 Note on autoscaling for stateful transformations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#materializing-data">6. Materializing data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-operations-grouping-aggregation-and-shuffling">7. Data Operations: grouping, aggregation, and shuffling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-batching-using-groupby">7.1. Custom batching using <code class="docutils literal notranslate"><span class="pre">groupby</span></code>.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregations">7.2. Aggregations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shuffling-data">7.3. Shuffling data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#file-based-shuffle-on-read">7.3.1. File based shuffle on read</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#shuffling-block-order">7.3.2. Shuffling block order</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#shuffle-all-rows-globally">7.3.3. Shuffle all rows globally</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#persisting-data">8. Persisting data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ray-data-in-production">9. Ray Data in production</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book community
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>